var Ha=Object.defineProperty,Ua=Object.defineProperties;var Za=Object.getOwnPropertyDescriptors;var Oi=Object.getOwnPropertySymbols;var Fa=Object.prototype.hasOwnProperty,Xa=Object.prototype.propertyIsEnumerable;var wi=(t,e,i)=>e in t?Ha(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,G=(t,e)=>{for(var i in e||(e={}))Fa.call(e,i)&&wi(t,i,e[i]);if(Oi)for(var i of Oi(e))Xa.call(e,i)&&wi(t,i,e[i]);return t},R=(t,e)=>Ua(t,Za(e));import{B as p,D as h,E as V,F as ui,ib as Ya,kE as Ba,ap as ja,_ as $,aS as qa,a8 as Yt,M as v,H as c,k$ as Wa,oO as Ka,hN as Ja,r8 as Qa,rZ as tn,hM as Y,kH as ni,lj as si,kK as en,li as Re,e4 as Pe,hR as _e,lo as Ze,s5 as an,aE as N,ku as Lt,kv as Ti,f_ as Ai,s6 as nn,fX as gi,b5 as ct,d3 as F,dE as ye,s3 as Fe,s4 as ut,es as sn,ed as B,s7 as Gi,Q as P,z as xt,s8 as _a,mx as k,iq as Pt,km as Xe,b7 as It,b8 as zt,aF as on,f$ as va,b6 as Di,az as rn,s9 as ln,sa as ya,h_ as pn,bi as T,y as re,ah as kt,i_ as $i,lp as M,mq as J,mb as x,nF as hn,f9 as Ie,nC as fa,js as X,nD as ze,j as Ma,mp as mi,eL as Ye,my as cn,nn as dn,g9 as L,kc as Le,g7 as Ve,kd as Vt,mZ as un,nG as gn,mS as ba,sb as mn,fB as oi,ar as _n,aR as ne,c_ as Sa,a6 as vn,sc as yn,sd as xa,eD as Be,nu as fn,a7 as _i,se as Mn,l0 as xe,kR as Ea,kT as Oa,iT as vi,g8 as bn,kI as Ri,V as yi,aV as Ht,sf as Ii,pG as Sn,fG as se,cT as xn,kN as Zt,ns as Pi,sg as En,d0 as ri,m1 as Mt,sh as On,si as wn,$ as Ce,eG as Tn,lq as wa,sj as An,mT as fe,ay as st,pB as zi,fF as Gn,g5 as Dn,n4 as Li,sk as Vi,nr as $n,bT as li,b9 as Rn,kG as Ta,nR as In,sl as Ci,lt as ki,l2 as Ni,nx as te,mw as Qt,kX as Hi,sm as Pn,sn as zn,lV as Xt,lZ as Ln,nz as At,m5 as Ui,aB as Qe,l$ as Vn,m3 as Cn,m4 as kn,nM as Nn}from"./vendor.fe24faac.js";import{x as Hn}from"./quantityFormatUtils.afcc4c0f.js";import{a as Un}from"./TextOverlayItem.bebb4aad.js";import{a as Zn,_ as Fn,F as Xn,G as Yn,n as Bn,r as jn,e as Et,d as Me,m as Ee,b as qn,f as Wn,l as Kn,g as Te}from"./drawSurfaces.88185707.js";import{g as be}from"./SnappingVisualizer3D.78553a2a.js";import{y as _,e as Wt,S as qt,r as fi}from"./GraphicState.da90c999.js";import{n as Jn}from"./Object3DVisualElement.aec1ab10.js";import{q as Zi,t as et,w as St,F as pi,b as de,v as Aa,O as Ga}from"./manipulatorUtils.5d13d6ff.js";import{t as Bt}from"./manipulatorUtils.a222f8ad.js";import{G as Da}from"./ExtendedLineVisualElement.eb8b9919.js";import{_ as hi}from"./VisualElementResources.9d2c136d.js";import{S as Qn}from"./PointVisualElement.ca6e97cf.js";import{N as Mi,G as $a,h as ts,T as es,F as is,P as as,C as ci}from"./dragEventPipeline3D.bea38d6a.js";import{x as ns,w as ss,p as lt,C as ve,d as os,b as le,G as Ra,D as ee,c as je,R as rs,M as ls}from"./InteractiveToolBase.e7b97dce.js";import{C as ps}from"./GraphicManipulator.0bbd5bdb.js";import{S as qe,X as hs,T as Fi,E as bt,t as cs,a as ds,s as us,c as gs,e as Xi}from"./EditGeometryOperations.c53784d5.js";import{e as ke}from"./SnappingContext.fb20e8e2.js";import{d as Ne,b as He,v as ms,g as _s}from"./euclideanLengthMeasurementUtils.a8ef0d06.js";import{y as Ct,o as Se,f as ti,s as Yi}from"./quantityUtils.4cba5101.js";import{l as vs,v as ys}from"./axisAngleDegrees.a0167a56.js";import{n as Ia,u as fs,s as Ms,v as bs,g as Ss,o as xs,d as Es,N as Os,w as ws,y as Bi,K as Ts,L as As,J as Gs,r as Ds,t as $s}from"./Factory.9dab653f.js";import"./geometryEngine.8edba19c.js";import"./geometryEngineBase.f43341a0.js";import"./hydrated.256778ed.js";import"./euclideanAreaMeasurementUtils.7e82b323.js";import"./measurementUtils.0b0f9c2a.js";import"./RightAngleQuadVisualElement.731859f0.js";import"./drawUtils.f401567c.js";import"./drapedUtils.afc22b3a.js";import"./PointSnappingHint.d370d403.js";import"./projectionUtils.485a4050.js";import"./LineVisualElement.3ebffa56.js";import"./ImageMaterial.885a8679.js";const Rs=3025,Is={default:15,far:25};let ht=class extends ui{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=Ya(async i=>{const a=await Ba("esri/core/t9n/Units");ja(i),this._messagesUnits=a}),e=()=>Pe(this.context,i=>i.editGeometryOperations);this.own([$(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>qa(e,i,()=>this._update())),Yt(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return v(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return Is[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(v(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const n=e.length;for(let s=0;s<n;++s){const o=[];if(e[s].iterateVertices(u=>{o.push(a.toXYZ(u.pos))}),s===0&&c(this.stagedVertex)&&o.push(a.toXYZ(this.stagedVertex)),o.length<2)continue;const r=o[0],l=o[o.length-1];i.type==="polygon"&&o.length>2&&!Wa(r,l)&&o.push(r);const d=n===1&&!Ka(o,!1,!1);let g=Ps,m=zs;this.toScreenPointArray(t,r,g);for(let u=1;u<o.length;++u){const f=o[u-1],y=o[u];this.toScreenPointArray(t,y,m),this._addLabel(t,f,g,y,m,d),[g,m]=[m,g]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,n,s){const{label:o}=this._getOrCreateLabel(t);if(!this.visible||Ja(i,n)<Rs)return void(o.visible=!1);const r=c(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":Qa(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,d=Zn(e,a,l,r),g=this._messagesUnits,m=tn(t.view);o.text=c(g)&&c(d)?Hn(g,d,m):"",o.visible=!0;const u=n[0]-i[0],f=n[1]-i[1];s?Y(it,-f,u):Y(it,f,-u),ni(it,it),si(it,it,this._edgeDistancePixels),en(ue,i,n,.5),Re(ue,ue,it),o.position=[ue[0],ue[1]],Math.abs(it[0])>Math.abs(it[1])?o.anchor=it[0]>0?"left":"right":o.anchor=-it[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new Un({fontSize:10,anchor:"center"});t.view.overlay.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){Pe(this.context,e=>e.view.overlay.items.remove(t)),t.destroy()}};p([h()],ht.prototype,"context",void 0),p([h()],ht.prototype,"stagedVertex",void 0),p([h()],ht.prototype,"visible",void 0),p([h()],ht.prototype,"edgeDistance",void 0),p([h()],ht.prototype,"updating",null),p([h()],ht.prototype,"_messagesUnits",void 0),p([h()],ht.prototype,"_edgeDistancePixels",null),ht=p([V("esri.views.interactive")],ht);const it=_e(),ue=_e(),Ps=Ze(),zs=Ze();let Ue=class extends ht{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,n=Ze()){const{spatialReference:s}=i.data.coordinateHelper;return an(a,s,e,t,ji),t.state.camera.projectToScreen(ji,n),n}};Ue=p([V("esri.views.3d.interactive.SegmentLabels3D")],Ue);const ji=N();class qi extends Jn{constructor(e){super(e),this.view=null,this._renderOccluded=Lt.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=_.colorToVec4(_.reshapeManipulators.vertex.color),this._size=_.reshapeManipulators.vertex.size,this._outlineColor=_.colorToVec4(_.reshapeManipulators.vertex.outlineColor),this._outlineSize=_.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Ti(e,this._color)||(Ai(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Ti(e,this._outlineColor)||(Ai(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(v(e)||e.length===0)return[];const i=.5,a=.5,n=nn(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,gi.fromElevationInfo(this.elevationInfo)),s=[],o=n.numVertices,r=n.position;for(let l=0;l<o;++l){const d=ct(Ls,r[3*l+0],r[3*l+1],r[3*l+2]),g=Wi(i,d),m=Wi(a,d);s.push({vertexGeometry:g,vertexOutlineGeometry:m})}return s}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:n}of i)e.addGeometry(a,this.vertexMaterial),e.addGeometry(n,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new Zi(R(G({},this.vertexMaterialParameters),{writeDepth:!0,cullFace:ye.Back,screenSizeEnabled:!0})),this.vertexOutlineMaterial=new Zi(R(G({},this.vertexOutlineMaterialParameters),{transparent:!0,writeDepth:!0,cullFace:ye.Front,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Ls=N();function Wi(t,e){return F.createSphereGeometry(t,16,16,{offset:e})}let Gt=class extends Fn{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.labelOptions=new Fe,this.tooltipOptions=new ut,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new sn({mode:t,offset:e})}normalizeCtorArgs(t){var e;if(!t.elevationInfo){const i=(e=t.hasZ)!=null?e:!0;return R(G({},t),{elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}})}return t}initializeGraphic(t){const e=this._createGraphicState=new Wt({graphic:t});return B([this.view.maskOccludee(t),this.view.trackGraphicState(e),$(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:i,isDraped:a})=>{Pe(i,n=>n.isDraped=a)},xt)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new Xn({view:this.view,manipulators:this.manipulators,geometryType:Yn(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Bn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new jn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new be,segmentLabels:e?new Ue:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Gi(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new qi({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=_.colorToVec4(_.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,Yt(()=>{this._activeVertexVisualElement=P(this._activeVertexVisualElement)}))}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new qt({view:this.view,geometry:t,elevationInfo:e,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Gi(this.hasZ,e)==="on-the-ground",attached:!1}),_.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),_.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Yt(()=>{this._outlineVisualElement=P(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new qi({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Yt(()=>{this._verticesVisualElement=P(this._verticesVisualElement)}))}};p([h({constructOnly:!0})],Gt.prototype,"elevationInfo",void 0),p([h({constructOnly:!0})],Gt.prototype,"geometryType",void 0),p([h({constructOnly:!0,type:Fe})],Gt.prototype,"labelOptions",void 0),p([h({constructOnly:!0,type:ut})],Gt.prototype,"tooltipOptions",void 0),p([h()],Gt.prototype,"type",void 0),p([h({constructOnly:!0})],Gt.prototype,"view",void 0),Gt=p([V("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Gt);var E;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(E||(E={}));var ot;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(ot||(ot={}));class Pa{constructor(){this.grabbingState=ot.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=ot.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===E.TRANSLATE_Z&&(this.zManipulator=i),i instanceof et&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),v(this.firstGrabbedXY)&&i.grabbing&&a===E.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=ot.ANY,a){case E.TRANSLATE_Z:this.grabbingState|=ot.Z;break;case E.TRANSLATE_XY:this.grabbingState|=ot.XY}})}}function Vs(t){const{view:e,graphic:i}=t,a=new Wt({graphic:i}),n=Cs(t,a),s=[n,ks(t,n.visualElement,a),e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:n.visualElement,remove:()=>B(s).remove()}}function Cs(t,e){const{view:i,graphic:a}=t,n=new qt({view:i,geometry:di(a)?a.geometry:null,elevationInfo:k(a),attached:!1});_.visualElements.lineGraphics.shadowStyle.apply(n);const s=()=>{n.attached=e.displaying};_.visualElements.lineGraphics.outline.apply(n);const o=[$(()=>e.displaying,s),$(()=>e.isDraped,r=>{n.isDraped=r}),e.on("changed",()=>n.geometry=di(a)?a.geometry:null),Pt(n)];return s(),{visualElement:n,remove:()=>B(o).remove()}}function ks(t,e,i){const{graphic:a,view:n}=t,s=[],o=k(a),r=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",l=new Pa,d=new Da({view:n,extensionType:_.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Lt.OccludeAndTransparent});_.visualElements.pointGraphics.shadowStyle.apply(d);const g=Xe(_.visualElements.heightPlaneAngleCutoff),m=new hi({view:n,attached:!1,angleCutoff:g});_.visualElements.heightPlane.apply(m);let u=1,f=1;const y=()=>{if(l.update(t),!i.displaying||r&&(i.isDraped||!di(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,d.attached=!1,void(m.attached=!1);e.laserlineEnabled=!0;{const S=l.grabbingState&ot.XY?_.visualElements.laserlineAlphaMultiplier:1;S!==u&&(u=S,_.visualElements.lineGraphics.shadowStyle.apply(e,S),_.visualElements.pointGraphics.shadowStyle.apply(d,S))}{const S=l.grabbingState&ot.Z?_.visualElements.laserlineAlphaMultiplier:1;S!==f&&(f=S,_.visualElements.heightPlane.apply(m,S))}Ns(d,l),Hs(t,e,m,l)};_.visualElements.zVerticalLine.apply(d),s.push(i.on("changed",y),$(()=>i.displaying,y),e.events.on("attachment-origin-changed",y),Pt(d),Pt(m));const b=[],w=()=>{B(b).remove(),b.length=0,t.forEachManipulator(S=>b.push(S.events.on("grab-changed",y))),t.forEachManipulator(S=>b.push(S.events.on("select-changed",y))),y()};return w(),s.push(t.onManipulatorsChanged(w),_a(()=>B(b))),B(s)}function Ns(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&c(e.firstGrabbedXY)?e.firstGrabbedXY:null;c(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function Hs(t,e,i,a){if(a.numSelected>0){ct(Ut,0,0,0);let n=0;t.forEachManipulator((s,o)=>{o===E.TRANSLATE_XY&&s.selected&&s instanceof et&&(It(Ut,Ut,s.renderLocation),n++)}),n>0?(i.heightManifoldTarget=zt(Ut,Ut,1/n),i.attached=!0):i.attached=!1}else{const n=e.attachmentOrigin;c(n)&&t.view.renderCoordsHelper.toRenderCoords(n,Ut)?(i.heightManifoldTarget=Ut,i.attached=!0):i.attached=!1}}function di(t){return c(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const Ut=N();function Us(t){const{view:e,graphic:i}=t,a=new Wt({graphic:i}),n=[],s=Fs(t,a,n);return Zs(t,a,n,s),n.push(e.trackGraphicState(a)),{visualElement:s,remove(){B(n).remove()}}}function Zs(t,e,i,a){const{view:n,graphic:s}=t,o=new Da({view:n,extensionType:_.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Lt.OccludeAndTransparent});_.visualElements.zVerticalLine.apply(o);const r=new hi({view:n,intersectsLineInfinite:!0,attached:!1});_.visualElements.pointGraphics.shadowStyle.apply(r);const l=Xe(_.visualElements.heightPlaneAngleCutoff),d=new hi({view:n,attached:!1,angleCutoff:l});_.visualElements.heightPlane.apply(d);const g=k(t.graphic),m=gi.fromElevationInfo(g),u=g.mode==="on-the-ground"||!g.offset&&g.mode!=="absolute-height",f=new Pa;let y=1,b=1;const w=()=>{f.update(t);const S=bi(s),A=u&&(e.isDraped||v(S)||!S.hasZ);let j=!0;if(!A&&c(S)){const z=va(S,n.elevationProvider,m,n.renderCoordsHelper);ct(nt,S.x,S.y,z),Di(nt,S.spatialReference,nt,n.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(nt),r.intersectsWorldUpAtLocation=nt}else j=!1;const pe=f.grabbingState&ot.Z?_.visualElements.laserlineAlphaMultiplier:1;pe!==y&&(y=pe,_.visualElements.heightPlane.apply(d,pe));const he=rn(js);!A&&e.displaying&&a.calculateMapBounds(he)&&Di(ln(he,nt),n.spatialReference,nt,n.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=nt,d.attached=!0):d.attached=!1;const gt=f.grabbingState&ot.XY?_.visualElements.laserlineAlphaMultiplier:1;gt!==b&&(b=gt,_.visualElements.pointGraphics.shadowStyle.apply(r,gt));const we=j&&e.displaying&&!A;r.attached=we,o.attached=we};i.push($(()=>[e.displaying,e.isDraped],w),e.on("changed",w)),t.forEachManipulator(S=>{i.push(S.events.on("grab-changed",w))}),i.push(Pt(r)),i.push(Pt(o)),i.push(Pt(d)),w()}function Fs(t,e,i){const{view:a,graphic:n}=t,s=new Qn({view:a,geometry:bi(n),elevationInfo:k(n),attached:!1});return Xs(t,s,e,i),i.push(Pt(s)),s}function bi(t){const e=t.geometry;return v(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function Xs(t,e,i,a){const n=()=>e.attached=i.displaying;Ys(t,e,i,a),_.visualElements.pointGraphics.outline.apply(e),a.push($(()=>i.displaying,n,xt))}function Ys(t,e,i,a){const{view:n,graphic:s}=t;let o=null;const r=d=>{c(o)&&(o.remove(),o=null),i.isDraped&&c(d)&&(o=Bs(n,d,()=>{e.geometry=d}))},l=()=>{const d=bi(s);r(d),e.geometry=d};a.push(i.on("changed",l),_a(()=>o)),l()}function Bs(t,e,i){const a=t.elevationProvider.spatialReference;pn(e,nt,a);const n=nt[0],s=nt[1];return t.elevationProvider.on("elevation-change",o=>{ya(o.extent,n,s)&&i()})}const nt=N(),js=on();function We(t){switch(T(t.graphic.geometry).type){case"point":case"mesh":return Us(t);case"polygon":case"polyline":return Vs(t);default:return null}}const qs=[1,.5,0],za=128,dt=70,Ws=80,La=.02,Ks=54,Js=100,Va=Math.ceil(dt/3*2),Ft=160,ei=.5,ii=24,Kt=9,Qs=Ft+30,Ki=Ft+53,to=60,eo=23,io=5*Math.PI/12,ao=1*Math.PI/3,Ji=10,Qi=.2,ta=30,ea=53,ia=.2,aa=.3,no=200,so=3,oo=1e6;class Oe{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof et&&e(i,a)})}}function Ke(t,e,i,a){const n=t.graphic,s=(o,r)=>e({action:o,graphic:n,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((o,r,l)=>{const d=r.next(g=>(g.action==="start"&&s("start",g),g)).next(ns(n,a)).next(g=>{switch(g.action){case"start":case"update":(g.translationX||g.translationY||g.translationZ)&&s("update",g);break;case"end":s("end",g)}return g});return l.next(ss(n)).next(()=>{s("end",{screenDeltaX:0,screenDeltaY:0})}),d})}function Ca(t){if(v(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class ro extends Oe{constructor(e){super(),this._handles=new re,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=dt,this._updateAfterDrag=!1,this.events=new kt,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=P(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,E.TRANSLATE_XY)}createGraphicDragPipeline(e,i,a){const n=i.graphic,s=k(n),o=T(n.geometry).spatialReference;return Ke(i,a,r=>this.createDragPipeline((l,d,g,m,u)=>r(l,e(l,d,g,m,u),g),s,o,n),this._view.state.viewingMode)}createDragPipeline(e,i,a,n){return B(this._arrowManipulatorInfos.map(({manipulator:s},o)=>lt(s,(r,l,d,g,m)=>{const u=l.next(f=>R(G({},f),{manipulatorType:E.TRANSLATE_XY})).next(ve(this._view,r.elevationAlignedLocation)).next(Mi(this._view,r.elevationAlignedLocation,i,a,n)).next(os(r.location,this.angle+(o+1)*Math.PI*.5)).next(le());e(r,u,d,g,m)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){const n=this._radius/dt,s=Ks*n,o=s*Math.sqrt(3)/2,r=F.createExtrudedTriangle(o,s/2,s/2,La);F.transformInPlace(r,$i(J.get(),ct(M.get(),0,-o/3,0))),e.renderObjects=[{geometry:r,material:this._opaqueMaterial,stateMask:x.Focused},{geometry:r,material:this._transparentMaterial,stateMask:x.Unfocused}],e.radius=o/3*2*1.2;const l=hn(J.get(),a*Math.PI/2),d=$i(J.get(),ct(M.get(),0,Js*n,0));Ie(i,l,d)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=fa(J.get(),e,X(0,0,1));if(v(i))return;const a=ze(J.get(),ct(M.get(),this.displayScale,this.displayScale,this.displayScale)),n=Ie(J.get(),a,i);for(const s of this._arrowManipulatorInfos){const o=Ie(J.get(),n,s.transform);s.manipulator.modelTransform=o}}_createArrowManipulator(e){const i=new et({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:X(0,0,1)}}),a={manipulator:i,transform:Ye()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const i=Ma.toUnitRGBA(fi.main);return i[3]*=e,new mi({color:i,transparent:e!==1,cullFace:ye.Back,renderOccluded:Lt.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class lo{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Ra,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,a=this._snap(this.lastDragEvent.screenEnd);if(c(a)){const n={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(n)}}this._enabled=e}_snap(e){const i=c(this.view)?this.view.toMap(e,{exclude:[]}):null;return c(i)&&c(this.view)&&(i.z=cn(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(e,i){return this.view=e,this.elevationInfo=i,this.lastDragEvent=null,a=>{if(this.lastDragEvent=a.action!=="end"?G({},a):null,this._enabled){const n=this._snap(a.screenEnd);return c(n)?{action:a.action,mapStart:a.mapStart,mapEnd:n,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class po extends Oe{constructor(e){super(),this._snapToScene=new lo,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=dt,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,E.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,a){const n=i.graphic,s=k(n),o=T(n.geometry).spatialReference;return Ke(i,a,r=>this.createDragPipeline((l,d,g,m,u)=>r(l,e(l,d,g,m,u),g),s,o,n),this._view.state.viewingMode)}createDragPipeline(e,i,a,n){const s=this._view;return lt(this._manipulator,(o,r,l,d,g)=>{const m=r.next(ve(s,o.elevationAlignedLocation)).next(Mi(s,o.elevationAlignedLocation,i,a,n)).next(this._snapToScene.createDragEventPipelineStep(s,i),this._snapToScene.next).next(u=>R(G({},u),{manipulatorType:E.TRANSLATE_XY})).next(le());e(o,m,l,d,g)})}_updateManipulatorTransform(){const e=ze(J.get(),ct(M.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new et({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:X(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=F.createCylinderGeometry(La,1,za,X(0,0,1),X(0,0,0)),i=ze(Ye(),X(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:i,stateMask:x.Focused},{geometry:e,material:this._discMaterialTransparent,transform:i,stateMask:x.Unfocused}],this._manipulator.radius=Ws*(this._radius/dt)}_createMaterial(e=1){const i=Ma.toUnitRGBA(fi.main);return i[3]*=e,new mi({color:i,transparent:e!==1,cullFace:ye.Back,renderOccluded:Lt.Transparent})}get test(){return{discManipulator:this._manipulator}}}class ho extends Oe{constructor(e){super(),this._radius=dt,this.events=new kt,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,E.TRANSLATE_Z)}createGraphicDragPipeline(e,i,a){const n=T(i.graphic.geometry).spatialReference;return Ke(i,a,s=>this.createDragPipeline((o,r,l,d,g)=>s(o,e(o,r,l,d,g),l),n),this._view.state.viewingMode)}createDragPipeline(e,i){const a=this._view;return lt(this._manipulator,(n,s,o,r,l)=>{const d=s.next(g=>R(G({},g),{manipulatorType:E.TRANSLATE_Z})).next($a(a,n.renderLocation,i)).next(le());e(n,d,o,r,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/dt,i=_.zManipulator.height*e,a=_.zManipulator.coneHeight*e,n=_.zManipulator.coneWidth*e,s=_.zManipulator.width*e,o=[X(0,0,0),X(0,0,i)],r=F.createTubeGeometry(o,s/2,16,!1),l=F.createConeGeometry(a,n/2,16,!1),d=[X(0,0,0),X(0,0,i+a)],g=S=>{const A=Ye();if(un(A,A,[0,0,i]),gn(A,A,Math.PI/2),S){const j=1+2*S/n;ba(A,A,[j,j,j])}return A},m=g(0),u=(S,A)=>{const j=mn(_.zManipulator.color,A);return[j.r/255,j.g/255,j.b/255,_.zManipulator.color.a*S]},f=St(u(1,.25),Lt.Occlude),y=St(u(1,0),Lt.Occlude),b=St(u(.7,0),_.zManipulator.renderOccluded),w=St(u(.85,0),_.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:m,material:f,stateMask:x.Unfocused},{geometry:r,material:f,stateMask:x.Unfocused},{geometry:l,transform:m,material:y,stateMask:x.Focused},{geometry:r,material:y,stateMask:x.Focused},{geometry:l,transform:m,material:b,stateMask:x.Unfocused},{geometry:r,material:b,stateMask:x.Unfocused},{geometry:l,transform:m,material:w,stateMask:x.Focused},{geometry:r,material:w,stateMask:x.Focused}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[d]}}_createManipulator(){const e=new et({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const a=this._view.state.camera,n=na;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,n);const s=dn(a.eye,n),o=a.computeRenderPixelSizeAtDist(s),r=L(Jt,n,a.eye);Le(r,r);const l=co;this._view.renderCoordsHelper.worldUpAtPosition(na,l);const d=Math.abs(Ve(r,l)),g=Vt(Jt,r,l),m=Vt(Jt,g,l),u=oi(d,.01,1),f=1-Math.sqrt(1-u*u)/u/a.fullWidth,y=this._radius/dt,b=_.zManipulator.width*y;zt(m,Le(m,m),(1/f-1)*s+o*b),i[12]-=Jt[0],i[13]-=Jt[1],i[14]-=Jt[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const na=N(),Jt=N(),co=N();class jt extends Oe{constructor(e){super(),this._handles=new re,this._angleDeferred=null,this._interactive=!0;const{tool:i,view:a,snapToScene:n,radius:s}=e;this._view=a,this.xyManipulation=new po({tool:i,view:a,snapToScene:n,radius:s}),this.xyAxisManipulation=new ro({tool:i,view:a,radius:s}),this.zManipulation=new ho({tool:i,view:a,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>{this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,a){return B([this.xyManipulation.createGraphicDragPipeline((n,s,o,r,l)=>e(D.XY,n,s,o,r,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((n,s,o,r,l)=>e(D.XY_AXIS,n,s,o,r,l),i,a),this.zManipulation.createGraphicDragPipeline((n,s,o,r,l)=>e(D.Z,n,s,o,r,l),i,a)])}createDragPipeline(e,i,a,n){return B([this.xyManipulation.createDragPipeline((s,o,r,l,d)=>e(D.XY,s,o,r,l,d),i,a,n),this.xyAxisManipulation.createDragPipeline((s,o,r,l,d)=>e(D.XY_AXIS,s,o,r,l,d),i,a,n),this.zManipulation.createDragPipeline((s,o,r,l,d)=>e(D.Z,s,o,r,l,d),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,E.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,E.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,E.TRANSLATE_Z))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(_n("esri-mobile"))return;const a=[];i.forEachManipulator(s=>a.push(s)),e.forEachManipulator(s=>a.push(s));const n=()=>{const s=[];this.xyAxisVisible?c(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator(o=>s.push(o.disableDisplay())),this._handles.remove(sa),this._handles.add(s,sa)};for(const s of a)this._handles.add(s.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(ne(()=>{var s;return(s=this._view.inputManager)==null?void 0:s.latestPointerType},n)),n()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=c(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?Va:dt}}const sa="disable-xy-axis-display";var D;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(D||(D={}));class Si extends Oe{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,E.TRANSLATE_XY)}createGraphicDragPipeline(e){return Ke(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,a=this._graphicState.graphic,n=c(a.geometry)?a.geometry.spatialReference:null;return lt(this._manipulator,(s,o,r,l,d)=>{const g=o.next(ts(d,i,a,n)).next(ee()).next(le());e(s,g,r,l,d)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new ps({graphic:i,view:e,selectable:!0,cursor:"move"})}}let tt=class extends Et{constructor(t){super(t),this.type="translate-graphic",this.distance=Ct}};p([h()],tt.prototype,"type",void 0),p([h()],tt.prototype,"distance",void 0),tt=p([V("esri.views.interactive.tooltip.TranslateGraphicTooltipInfo")],tt);let rt=class extends Et{constructor(t){super(t),this.type="translate-z",this.distance=Ct}};p([h()],rt.prototype,"type",void 0),p([h()],rt.prototype,"distance",void 0),rt=p([V("esri.views.interactive.tooltip.TranslateZTooltipInfo")],rt);let Dt=class extends Et{constructor(t){super(t),this.type="translate-vertex",this.distance=Ct,this.elevation=null,this.area=null,this.totalLength=null}};p([h()],Dt.prototype,"type",void 0),p([h()],Dt.prototype,"distance",void 0),p([h()],Dt.prototype,"elevation",void 0),p([h()],Dt.prototype,"area",void 0),p([h()],Dt.prototype,"totalLength",void 0),Dt=p([V("esri.views.interactive.tooltip.TranslateVertexTooltipInfo")],Dt);class uo{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class go{constructor(e,i,a){this.dx=e,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class oa{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let mt=class extends Sa(kt.EventedMixin(je)){constructor(t){super(t),this.graphics=new vn,this.enableZ=!0,this.tooltipOptions=new ut,this.type="move-3d",this._snappingPipeline=new Ne,this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.own([t.on("change",()=>this._refreshManipulators()),$(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new Ee({view:e}):P(this._tooltip)},_i)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=P(this._tooltip),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>yn(e)===xa.SUPPORTED).map(e=>new mo(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Si({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",n=>{this.emit("immediate-click",R(G({},n),{graphic:i.graphic})),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{const{tooltipOptions:s,_tooltip:o}=this;v(o)||(n==="focus"?o.info=new tt({tooltipOptions:s}):o.clear())})])),this.handles.add(e.manipulationXY.createDragPipeline((a,n,s,o)=>this._buildDragEventPipeline(t,D.XY,a,n,s,o)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new jt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?jt.radiusForSymbol(t[0].graphic.symbol):dt});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((n,s)=>{this.handles.add(n.events.on("immediate-click",o=>{e.zManipulation.hasManipulator(n)||this.graphics.length!==1||this.emit("immediate-click",R(G({},o),{graphic:this.graphics.getItemAt(0)})),o.stopPropagation()})),s===E.TRANSLATE_XY&&this.handles.add(n.events.on("focus-changed",({action:o})=>{const{tooltipOptions:r,_tooltip:l}=this;v(l)||(o==="focus"?l.info=new tt({tooltipOptions:r}):l.clear())})),s===E.TRANSLATE_Z&&this.handles.add(n.events.on("focus-changed",({action:o})=>{const{tooltipOptions:r,_tooltip:l}=this;v(l)||(o==="focus"?l.info=new rt({tooltipOptions:r}):l.clear())}))});const i=()=>this._updateMoveManipulation(t);for(const n of t)this.handles.add([n.state.on("changed",i),$(()=>n.state.displaying,i)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(e.createDragPipeline((n,s,o,r,l)=>this._buildDragEventPipeline(t,n,s,o,r,l),k(a.graphic),T(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=We({view:this.view,graphic:i,forEachManipulator:n=>{e.manipulationXY.forEachManipulator(n),this._moveManipulation.forEachManipulator(n)},onManipulatorsChanged:()=>Yt()});v(a)||(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof qt&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),$(()=>e.state.isDraped,()=>this._updateMoveManipulation(t))]),this.handles.add(a))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>Ca(t.graphic.geometry)}_updateMoveManipulation(t){const e=Be(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;for(const s of t){if(!s.state.displaying)continue;const o=s.state.graphic;this.enableZ&&Bt(o)&&(a=!0);const r=s.geometryRepresentation instanceof qt&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:pi(this.view,o);c(r)&&(e.x+=r.x,e.y+=r.y,e.z+=r.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}_buildDragEventPipeline(t,e,i,a,n,s){const o=[],r=[];let l=null,d=null;const g=()=>{for(const u of o)u.dragging=!1;o.length=0,r.length=0,l=null,d=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===D.XY){const u=t[0].graphic;a=this._buildSnappingPipelineSteps(u,k(u),a,n,s)}const m=a.next(u=>{if(u.action==="start"){o.length=0,r.length=0;for(const f of t)f.dragging||!f.manipulationXY.hasManipulator(i)&&f.manipulationXY.grabbing||(o.push(f),r.push(f.graphic),f.dragging=!0);if(r.length!==0&&(this._moveManipulation.interactive=!1,l=rs(r,this.view.state.viewingMode),d=ls(r),this.emit("graphic-move-start",new uo(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l(u)).next(u=>this._updateMoveTooltip(u,e,t)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const f=this.view.toScreen(u.mapStart),y=this.view.toScreen(u.mapEnd),b=y.x-f.x,w=y.y-f.y;if(this.emit("graphic-move",new go(b,w,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new oa(r)),this.destroyed)return null;g()}});return n.next(u=>d(u)).next(()=>{if(this.emit("graphic-move-stop",new oa(r)),this.destroyed)return null;g()}),m}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:n}=this;if(v(n))return t;if(n.clear(),e===D.XY||e===D.XY_AXIS)if(t.action==="end")n.info=new tt({tooltipOptions:a});else{const s=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height",o=Me(t.mapStart,t.mapEnd,s);c(o)&&(n.info=new tt({tooltipOptions:a,distance:o}))}return e===D.Z&&(t.action==="end"?n.info=new rt({tooltipOptions:a}):Pe(He(t.mapStart,t.mapEnd),s=>{n.info=new rt({tooltipOptions:a,distance:s})})),t}_buildSnappingPipelineSteps(t,e,i,a,n){const s=t.geometry;if(v(s)||s.type!=="point"&&s.type!=="mesh")return i;const o=(s.type==="point"?s:s.anchor).clone(),r=new ke({elevationInfo:e,pointer:n,editGeometryOperations:qe.fromGeometry(o,this.view.state.viewingMode),visualizer:new be,excludeFeature:t}),l=this.snappingManager;return i.next(d=>(o.z=fn(this.view,o,k(t),{mode:"absolute-height",offset:0}),R(G({},d),{snapOrigin:r.coordinateHelper.pointToVector(o)}))).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:r,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};p([h({constructOnly:!0,nonNullable:!0})],mt.prototype,"view",void 0),p([h()],mt.prototype,"graphics",void 0),p([h({constructOnly:!0,nonNullable:!0})],mt.prototype,"enableZ",void 0),p([h({constructOnly:!0,type:ut})],mt.prototype,"tooltipOptions",void 0),p([h({constructOnly:!0})],mt.prototype,"snappingManager",void 0),p([h()],mt.prototype,"type",void 0),p([h()],mt.prototype,"updating",null),mt=p([V("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],mt);class mo{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Wt({graphic:e})}get graphic(){return this.state.graphic}}function ra(t,e,i){const a=i.mode==="on-the-ground"?Fi.XY:Fi.XYZ;return new hs(t,a,e,0)}function la(t,e,i){const a=N();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const n=pa(t,e,xe(i.plane)),s=pa(t,e,i.edgeDirection);if(v(n)||v(s))return null;const o=Vt(N(),n,s);return Oa(a,o,vi())}function pa(t,e,i){const a=Be(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),n=N(),s=N();return t.renderCoordsHelper.toRenderCoords(e,n)&&t.renderCoordsHelper.toRenderCoords(a,s)?Ea(s,n,s):null}function _o(t,e,i){const a=xe(t),n=Ea(N(),e,i),s=Vt(N(),n,a),o=Vt(N(),n,s);return Mn(n[0],n[1],n[2],0,s[0],s[1],s[2],0,o[0],o[1],o[2],0,0,0,0,1)}function vo(t,e,i){const a=i.projectToRenderScreen(t,Ri()),n=i.projectToRenderScreen(e,Ri());return c(a)&&c(n)?bn(L(a,a,n)):0}let ie=class extends Et{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Ct}};p([h()],ie.prototype,"type",void 0),p([h()],ie.prototype,"distance",void 0),ie=p([V("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],ie);let C=class extends kt.EventedMixin(yi){constructor(t){super(t),this._vertexManipulatorMaterial=St(_.colorToVec4(_.reshapeManipulators.vertex.color),_.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=de(_.colorToVec4(_.reshapeManipulators.vertex.outlineColor),_.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=de(_.colorToVec4(_.reshapeManipulators.vertex.hoverOutlineColor),_.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=St(_.colorToVec4(_.reshapeManipulators.edge.color),_.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=de(_.colorToVec4(_.reshapeManipulators.edge.outlineColor),_.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=St(_.colorToVec4(_.reshapeManipulators.edgeOffset.color),_.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=St(_.colorToVec4(_.reshapeManipulators.edgeOffset.hoverColor),_.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=St(_.colorToVec4(_.reshapeManipulators.selected.color),_.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=de(_.colorToVec4(_.reshapeManipulators.selected.outlineColor),_.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=de(_.colorToVec4(_.reshapeManipulators.selected.hoverOutlineColor),_.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new re,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=I.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new Ne,this._snappingPipelineHandle=new Ne,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new Wt({graphic:t});this._tooltip=new Ee({view:e}),this.own([$(()=>i.displaying,a=>{for(const n of this._manipulatorInfos)n.manipulator.available=a}),$(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:n,edgeOffsetEnabled:s})=>{c(a)&&(a.visible=n,a.edgeDistance=s?"far":"default")},xt),ne(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),xt),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=P(this._segmentLabels),this._tooltip=P(this._tooltip),this._editGeometryOperations=P(this._editGeometryOperations),this._moveManipulation=P(this._moveManipulation),this._graphicMoveManipulation=P(this._graphicMoveManipulation),this._manipulatorHandles=P(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=P(this._moveManipulation),this._graphicMoveManipulation=P(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(v(this._editGeometryOperations))return;const t=k(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(v(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(v(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),v(t)||(P(this._editGeometryOperations),this._editGeometryOperations=qe.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(),P(this._segmentLabels),this._segmentLabels=new Ue({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:k(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0;const a=[],n=this._manipulatorInfos.some(o=>o.type==="vertex"&&o.manipulator.selected),s=t===ae.SELECTED_OR_ALL&&n;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.grabbing||s&&!o.manipulator.selected||a.push(o),i++);if(a.length===0)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(I.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(I.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)e.type==="vertex"&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(I.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const n=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===t.info)&&n.push(s);this._moveVertices(n,t,bt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case I.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case I.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case I.MOVING:switch(this._reshapeEventState){case I.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case I.RESHAPING:switch(this._reshapeEventState){case I.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case I.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){const{graphic:e,handles:i,tool:a,view:n}=this,s=this._graphicState;if(this._graphicMoveManipulation=new Si({tool:a,view:n,graphicState:s}),this.enableMoveGraphic){let l=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((d,g,m)=>{g.next(u=>this._trackNumDragging(u)).next(u=>(u.action==="start"&&(l=T(this._editGeometryOperations).createUndoGroup()),u)).next(u=>this._perGraphicManipulatorDragAction(ae.ALL,u)).next(u=>(this._updateTranslateGraphicTooltip(D.XY,u),u)).next(u=>{u.action==="end"&&(this._tooltip.clear(),l=Ht(l))}),m.next(this._cancelDragOperation(()=>l=Ht(l)))}))}else this._graphicMoveManipulation.forEachManipulator(l=>{l.grabbable=!1,l.cursor=null});this._graphicMoveManipulation.forEachManipulator(l=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",d=>{this._manipulatorInfos.some(g=>g.manipulator.selected)?this._clearSelection():this.emit("immediate-click",R(G({},d),{graphic:this.graphic})),d.stopPropagation()})])),this._moveManipulation=new jt({tool:a,view:n,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Bt(e),snapToScene:!1,radius:jt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((l,d)=>{i.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",g=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(m=>m.manipulator.selected)||this.emit("immediate-click",R(G({},g),{graphic:e})),g.stopPropagation()})]),i.add(l.events.on("focus-changed",({action:g})=>{g==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(d===E.TRANSLATE_Z?D.Z:D.XY):this._tooltip.clear()}))}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const o=T(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,d,g,m,u)=>{const f=g.next(y=>this._trackNumDragging(y)).next(y=>{const b=this._manipulatorInfos.filter(w=>w.type==="vertex"&&w.manipulator.selected);return y.manipulatorType===E.TRANSLATE_XY&&b.length===1?R(G({},y),{info:b[0],snapOrigin:b[0].handle.pos}):R(G({},y),{info:null})}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:y=>!!y.info,cancel:m,snappingManager:a.snappingManager,snappingContext:new ke({editGeometryOperations:T(this._editGeometryOperations),elevationInfo:t,pointer:u,excludeFeature:e,visualizer:new be}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(ee()).next(y=>this._perGraphicManipulatorDragAction(ae.SELECTED_OR_ALL,y)).next(y=>(this._updateTranslateTooltip(l,y),y));return m.next(this._cancelDragOperation()),f},t,o,e),$(()=>s==null?void 0:s.displaying,()=>{this._updateMoveManipulationPosition()},xt),s.on("changed",()=>this._updateMoveManipulationPosition()),$(()=>s==null?void 0:s.isDraped,l=>{const d="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),d):i.remove(d)},xt)]),this._updateMoveManipulationPosition();const r=We({view:n,graphic:e,forEachManipulator:l=>{if(!this.destroyed){c(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(l);for(const d of this._manipulatorInfos)l(d.manipulator,E.TRANSLATE_XY);this._moveManipulation.forEachManipulator(l)}},onManipulatorsChanged:l=>this.on("manipulators-changed",l)});c(r)&&(this._outlineVisualElement=r.visualElement instanceof qt?r.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{s.isDraped||this._updateMoveManipulationPosition()}),$(()=>s.isDraped,()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(r)}_createEdgeOffsetManipulator(t,e=k(this.graphic)){const i=_.reshapeManipulators.edgeOffset,a=i.size/2,n=a+i.collisionPadding;if(v(this._edgeOffsetManipulatorGeometryInside)||v(this._edgeOffsetManipulatorGeometryOutside)){const u=a/n,f=u*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=F.createExtrudedTriangle(f,u/2,u/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=F.createExtrudedTriangle(-f,u/2,u/2,i.height,-i.offset)}const s=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused}],o=new et({view:this.view,renderObjects:s,elevationInfo:e.mode!=="on-the-ground"||Ii(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:X(0,0,1)},collisionPriority:1}),r=new et({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:o,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:r,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const d=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),g=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=B([d,g]),this._manipulatorHandles.add(l.locationUpdateHandle,o),this._manipulatorHandles.add([this._watchAndUpdateGrabState(o,!0),this._watchAndUpdateGrabState(r,!0)],o),this._manipulatorHandles.add(lt(o,this._createEdgeOffsetPipeline(l,e)),o),this._manipulatorHandles.add(lt(r,(u,f,y,b)=>{if(b==="touch")this._createEdgeOffsetPipeline(l,e)(u,f,y);else if(this.enableMoveGraphic){const w=this.graphic,S=c(w.geometry)?w.geometry.spatialReference:null;f.next(A=>this._trackNumDragging(A)).next(ve(this.view,u.elevationAlignedLocation)).next(Mi(this.view,u.elevationAlignedLocation,e,S,w)).next(le()).next(ee()).next(A=>this._perGraphicManipulatorDragAction(ae.ALL,A)).next(A=>(this._updateTranslateGraphicTooltip(D.XY,A),A)).next(A=>{A.action==="end"&&this._tooltip.clear()}),y.next(this._cancelDragOperation())}}),o);const m=u=>{this._manipulatorInfos.some(f=>f.manipulator.selected)?this._clearSelection():this.emit("immediate-click",R(G({},u),{graphic:this.graphic})),u.stopPropagation()};return this._manipulatorHandles.add([o.events.on("immediate-click",m),r.events.on("immediate-click",m),o.events.on("focus-changed",({action:u})=>{const f=this._tooltipOptions;u==="focus"&&f.enabled?this._tooltip.info=new ie({tooltipOptions:f}):this._tooltip.clear()})],o),this._manipulatorInfos.push(l),this.manipulators.add(o),this.manipulators.add(r),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,n=()=>{Ht(t.visibilityHandle);const s=vo(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||s)&&(i.grabbable=!s,a.grabbable=!s,t.visibilityHandle=B([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",n),a.events.on("focus-changed",n),{remove:()=>{Ht(t.visibilityHandle),this.manipulators.remove(a)}}],i),n()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=T(this._editGeometryOperations).data.coordinateHelper,i=la(this.view,t.manipulator.elevationAlignedLocation,ra(e,t.handle,T(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,n=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,s=c(i)?_o(i,a,n):Sn;t.manipulator.modelTransform=s,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=s;const o=se(L(Ae,a,n))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-o,0,0],[o,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,n)=>{this._clearSelection();const{step:s,cleanup:o}=this._initializeEdgeOffset(t,e);a.next(r=>this._trackNumDragging(r)).next(ve(this.view,i.elevationAlignedLocation)).next(s).next(es(this.view)).next(is(this.view,T(this._editGeometryOperations).data.spatialReference)).next(ee()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&o()}),n.next(r=>(o(),r)).next(r=>(this._tooltip.clear(),r)).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const i=T(this._editGeometryOperations),a=ra(i.data.coordinateHelper,t.handle,e),n=i.createUndoGroup(),s=la(this.view,t.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const o=()=>new xn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:T(this._editGeometryOperations).data.spatialReference}),r=new qt({view:this.view,isDraped:this._graphicState.isDraped,geometry:o(),elevationInfo:t.elevationInfo,width:_.visualElements.lineGraphics.outline.width,color:_.colorToVec4(fi.main),attached:!0});let l;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=Ht(l)},g=this.on("undo",d);return l=B([Pt(r),$(()=>this._graphicState.isDraped,m=>r.isDraped=m),this._graphicState.on("changed",()=>r.geometry=o()),n,g]),{step:m=>v(a)||v(s)?(d(),null):R(G({},m),{operation:a,plane:s}),cleanup:d}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||v(e.operation))return e;this._updateEventState(I.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:n}=e;return(i||a||n)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;if(v(e)||v(i))return t;const a=e.signedDistanceToPoint(i);return R(G({},t),{signedDistance:a})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,n=this._tooltip,s=this._tooltipOptions;if(!s.enabled||v(i))return n.clear(),t;const o=yo(this._graphicState.isDraped,-i,e,a.plane,T(this._editGeometryOperations).data.coordinateHelper);return v(n.info)||n.info.type!=="reshape-edge-offset"?n.info=new ie({tooltipOptions:s,distance:o}):n.info.distance=o,t}}_cleanEdgeOffsetCollapsedEdges(t){var l,d;const e=(l=t.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,i=t.handle.leftVertex,a=(d=t.handle.rightVertex.rightEdge)==null?void 0:d.rightVertex,n=t.handle.rightVertex,s=T(this._editGeometryOperations).data.coordinateHelper,o=1e-6,r=[];e&&s.distance(e.pos,i.pos)<o&&r.push(this._getManipulatorInfoFromHandle(i)),(s.distance(i.pos,n.pos)<o||a&&s.distance(a.pos,n.pos)<o)&&r.push(this._getManipulatorInfoFromHandle(n)),r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=k(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(v(this._vertexManipulatorGeometry)||v(this._vertexManipulatorOutlineGeometry)){const{size:o,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(_.reshapeManipulators.vertex);this._vertexManipulatorGeometry=F.createSphereGeometry(o,16,16),this._vertexManipulatorOutlineGeometry=F.createSphereGeometry(r,16,16)}if(v(this._edgeManipulatorGeometry)||v(this._edgeManipulatorOutlineGeometry)){const{size:o,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(_.reshapeManipulators.edge);this._edgeManipulatorGeometry=F.createSphereGeometry(o,16,16),this._edgeManipulatorOutlineGeometry=F.createSphereGeometry(r,16,16)}const i=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:at.Vertex|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:at.Vertex|x.Unfocused|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:at.Vertex|x.Focused|x.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:x.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:x.Selected|x.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:x.Selected|x.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:at.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:at.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:at.Edge|x.Unfocused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:at.Edge|x.Unfocused|x.Unselected});const a=new et({view:this.view,renderObjects:i,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,t,e);const n=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(a),this._updateManipulatorPosition(n),n.type==="edge"){const o=this._getManipulatorInfoFromHandle(n.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(n)),r=this._getManipulatorInfoFromHandle(n.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(n));n.locationUpdateHandle=B([o,r]),this._manipulatorHandles.add(n.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const s=lt(a,(o,r,l,d)=>{let g=null;r.next(m=>this._trackNumDragging(m)).next(m=>{if(m.action==="start"&&(g=T(this._editGeometryOperations).createUndoGroup()),n.type==="edge"){const u=this._splitEdgeManipulator(n);return R(G({},m),{info:u,snapOrigin:u.handle.pos})}return R(G({},m),{info:n,snapOrigin:n.handle.pos})}).next(ve(this.view,o.elevationAlignedLocation)).next(as(this.view,this.graphic,o.elevationAlignedLocation,o.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new ke({editGeometryOperations:T(this._editGeometryOperations),elevationInfo:e,pointer:d,excludeFeature:this.graphic,visualizer:new be}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(ee()).next(m=>{this._perVertexManipulatorDragAction(m),m.action==="end"&&(g=Ht(g)),this._updateTranslateVertexTooltip(o,D.XY,m)}),l.next(this._cancelDragOperation(()=>g=Ht(g)))});return this._manipulatorHandles.add([s,a.events.on("immediate-click",o=>this._manipulatorClickCallback(o,n)),a.events.on("select-changed",()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:o})=>{o==="focus"&&n.type!=="edge"?this._updateTranslateVertexTooltip(a,D.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),n}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case I.NONE:break;case I.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(I.NONE)}}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=at.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=_.reshapeManipulators.vertex.size/2+_.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=at.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=_.reshapeManipulators.edge.size/2+_.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||Ii(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>this._onGrabStateChanged(t,e,i.action,i.pointerType))}_onGrabStateChanged(t,e,i,a="mouse"){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(I.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(n=>{n.manipulator.interactive=!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in n&&(n.edgeManipulator.interactive=!this._numGrabbing)}),T(this._graphicMoveManipulation).forEachManipulator(n=>n.interactive=!this._numGrabbing))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(t.manipulator.grabbing&&this._onGrabStateChanged(t.manipulator,!1,"end"),this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(!t)return;const e=T(this._editGeometryOperations);if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,ge),t.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(c(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const n=i.location,s=a.location,o=.5,r=n.x+o*(s.x-n.x),l=n.y+o*(s.y-n.y),d=n.hasZ&&s.hasZ?0:void 0;t.manipulator.location=Be(r,l,d,e.data.spatialReference)}else Zt(Ae,i.renderLocation,a.renderLocation,.5),t.manipulator.renderLocation=Ae}}_splitEdgeManipulator(t,e=.5){const i=T(this._editGeometryOperations),a=T(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const n=k(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(t),s=this._createVertexOrEdgeManipulator(a)):(s=t,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,D.XY),this._updateSelection(t.manipulator);const o=this._updateEventState(I.RESHAPING),r=i.data.coordinateHelper.vectorToArray(s.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:T(a.index)}],added:r}),o&&this._updateEventState(I.NONE),s}_updateMoveManipulationPosition(){const t=ct(Ae,0,0,0);let e=0,i=!1,a=null,n=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(e++,It(t,t,s.manipulator.renderLocation),v(a)||s.selectedIndex>a.selectedIndex?(n=a,a=s):(v(n)||s.selectedIndex>n.selectedIndex)&&(n=s)):i=!0);if(e!==0){const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&Bt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&e!==1}else{const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&Bt(this.graphic)}if(e!==0){let s=0;if(c(a)){const o=a.handle.pos,r=c(n)?n.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=v(n)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;r&&l?this._moveManipulation.xyAxisManipulation.available=!1:r?s=ha(r,o):l&&(s=ha(o,l))}this._moveManipulation.angle=s,this._moveManipulation.radius=Va}else this._moveManipulation.angleDeferred=()=>Ca(T(this.graphic.geometry)),this._moveManipulation.radius=jt.radiusForSymbol(this.graphic.symbol);e!==0&&i?(zt(t,t,1/e),ge.spatialReference=T(this._editGeometryOperations).data.spatialReference,ge.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,ge),this._moveManipulation.elevationAlignedLocation=ge):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Aa(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=T(this._editGeometryOperations);for(const a of t)if(a.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const n=T(i.removeVertices([a.handle]).removedVertices[0].createdEdge);n&&this._createVertexOrEdgeManipulator(n)}if(e.length>0){const a=e.map(s=>{const o=i.data.components.indexOf(s.component);return{coordinates:i.data.coordinateHelper.vectorToArray(s.pos),componentIndex:o,vertexIndex:T(s.index)}});this.outputGeometry=i.data.geometry;const n=this._updateEventState(I.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||n&&(this._updateEventState(I.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?bt.NEW_STEP:bt.ACCUMULATE_STEPS){const a=T(this._editGeometryOperations);a.moveVertices(t.map(n=>n.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const n of t)this._updateManipulatorPosition(n)}_offsetEdge(t,e){if(v(e.operation)||v(e.signedDistance))return;const i=T(this._editGeometryOperations),a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Pi.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Pi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=t===D.Z,n=a?new rt({tooltipOptions:i}):new tt({tooltipOptions:i});if(c(e)&&e.action!=="end"){const{mapStart:s,mapEnd:o}=e,r=a?He(s,o):Me(s,o,this._graphicState.isDraped?"on-the-ground":"absolute-height");n.distance=c(r)?r:Ct}this._tooltip.info=n}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;const n=e===D.Z,s=new Dt({tooltipOptions:a});if(c(i)&&i.action!=="end"){const{mapStart:l,mapEnd:d}=i,g=n?He(l,d):Me(l,d,this._graphicState.isDraped?"on-the-ground":"absolute-height");s.distance=c(g)?g:Ct}const o=ms(t.elevationAlignedLocation);c(o)&&(s.elevation=G({mode:"absolute-height"},o));const{geometry:r}=this.graphic;c(r)&&!n&&(s.area=r.type==="polygon"?qn(r,this._graphicState.isDraped):null,s.totalLength=r.type==="polyline"?Wn(r,this._graphicState.isDraped?"on-the-ground":"absolute-height"):null),this._tooltip.info=s}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function ha(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function yo(t,e,i,a,n){if(t){const s=n.toXYZ(n.pointToVector(i)),o=En(a,s,M.get()),r=Kn(o,s,n.spatialReference);if(c(r))return Se(r.value*Math.sign(e),r.unit)}return Se(e*ri(i.spatialReference),"meters")}p([h()],C.prototype,"_segmentLabels",void 0),p([h({constructOnly:!0})],C.prototype,"tool",void 0),p([h()],C.prototype,"_tooltip",void 0),p([h()],C.prototype,"inputGeometry",null),p([h()],C.prototype,"outputGeometry",void 0),p([h({readOnly:!0})],C.prototype,"updating",null),p([h()],C.prototype,"manipulators",null),p([h()],C.prototype,"view",null),p([h()],C.prototype,"graphic",null),p([h()],C.prototype,"enableZShape",null),p([h()],C.prototype,"enableZVertex",null),p([h()],C.prototype,"enableMoveGraphic",null),p([h()],C.prototype,"enableMidpoints",null),p([h()],C.prototype,"enableEdgeOffset",null),p([h()],C.prototype,"_labelOptions",null),p([h()],C.prototype,"_tooltipOptions",null),C=p([V("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],C);const ge=Be(0,0,null,null),Ae=N();var at,I,ae;(function(t){t.Vertex=Mt.Custom1,t.Edge=Mt.Custom2})(at||(at={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(I||(I={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(ae||(ae={}));let U=class extends kt.EventedMixin(je){constructor(t){super(t),this._handles=new re,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Fe,this.tooltipOptions=new ut,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new C({tool:this});this.own([t.on("reshape",e=>{e.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",e)}),t.on("move",e=>{e.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",e)}),t.on("vertex-add",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)}),t.on("vertex-remove",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)}),t.on("immediate-click",e=>this.emit("immediate-click",e)),this.view.on("pointer-down",["Shift"],e=>{e.stopPropagation()}),$(()=>this.graphic,()=>this._updateGraphic(),_i)]),this.finishToolCreation()}destroy(){this._handles=P(this._handles),this._reshapeOperation=P(this._reshapeOperation)}get updating(){var t,e;return(e=(t=this._reshapeOperation)==null?void 0:t.updating)!=null?e:!1}_updateGeometry(){const t=On(this.graphic);this._reshapeOperation.inputGeometry=c(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),wn(this.graphic)!==xa.SUPPORTED)return;const t=$(()=>{var e;return(e=this.graphic)==null?void 0:e.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},Ce);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){v(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){var t;return(t=this._reshapeOperation.canUndo)!=null?t:!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t;return(t=this._reshapeOperation.canRedo)!=null?t:!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};p([h()],U.prototype,"_reshapeOperation",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),p([h({constructOnly:!0})],U.prototype,"graphic",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZShape",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZVertex",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMoveGraphic",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMidpoints",void 0),p([h({constructOnly:!0,nonNullable:!0})],U.prototype,"enableEdgeOffset",void 0),p([h()],U.prototype,"type",void 0),p([h({constructOnly:!0,type:Fe})],U.prototype,"labelOptions",void 0),p([h({constructOnly:!0,type:ut})],U.prototype,"tooltipOptions",void 0),p([h({constructOnly:!0})],U.prototype,"snappingManager",void 0),p([h()],U.prototype,"updating",null),p([h()],U.prototype,"automaticManipulatorSelection",void 0),U=p([V("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],U);let _t=class extends Et{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};p([h()],_t.prototype,"type",void 0),p([h()],_t.prototype,"rotation",void 0),p([h()],_t.prototype,"rotationPrecision",void 0),p([h()],_t.prototype,"orientation",void 0),p([h()],_t.prototype,"orientationPrecision",void 0),p([h()],_t.prototype,"rotationType",void 0),_t=p([V("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],_t);let $t=class extends Et{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};p([h()],$t.prototype,"type",void 0),p([h()],$t.prototype,"scale",void 0),p([h()],$t.prototype,"size",void 0),p([h()],$t.prototype,"sizeUnit",void 0),p([h()],$t.prototype,"sizePrecision",void 0),$t=p([V("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],$t);let Q=class extends Et{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};p([h()],Q.prototype,"type",void 0),p([h()],Q.prototype,"orientation",void 0),p([h()],Q.prototype,"orientationEnabled",void 0),p([h()],Q.prototype,"orientationPrecision",void 0),p([h()],Q.prototype,"rotationType",void 0),p([h()],Q.prototype,"size",void 0),p([h()],Q.prototype,"sizeUnit",void 0),p([h()],Q.prototype,"sizeEnabled",void 0),p([h()],Q.prototype,"sizePrecision",void 0),Q=p([V("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Q);var O,oe;(function(t){t.ScaleIn=Mt.Custom2,t.ScaleOut=Mt.Custom3,t.RotateLeft=Mt.Custom4,t.RotateRight=Mt.Custom5,t.Unlocked=Mt.Custom7,t.DelayedFocused=Mt.Custom8,t.TouchInput=Mt.Custom12})(O||(O={}));class fo{constructor({adapter:e,tooltipOptions:i,mode:a,tool:n}){this.mode=null,this._handles=new re,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new kt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=n,this.mode=a,this.adapter=e,this._tooltipOptions=i,this._tooltip=new Ee({view:n.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(ne(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),xt))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=P(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=P(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=Tn({update:({deltaTime:a})=>{e.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation=R(G({},e),{frameTask:i})}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=P(this._activeAnimation))}forEachManipulator(e){e(this._ringManipulator,E.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const i=this.tool.graphicState.graphic,a=lt(e,(n,s,o)=>{this._scaleRotateDragData=null;const r=this.adapter.startInteraction(),l={mode:"none",origin:wa(n.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const d=M.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(n.renderLocation,d),s.next(ci(this.tool.view,Oa(n.renderLocation,d,vi()))).next(g=>{const m=xe(g.plane),u=Ga(g.renderStart,g.renderEnd,l.origin,m),f=An.shortestSignedDiff(l.angle,u);l.angleDir=oi(l.angleDir+f,-aa,aa),l.angle=u;const y=Mo(l,g),b=y-this.adapter.scale;if(l.scaleDir=oi(l.scaleDir+b,-ia,ia),this._onScaleChanged(),l.mode==="none"){const w=this.mode||bo(g,g.plane,l.origin,this.tool.view.state.camera);if(c(w)){switch(w){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}l.mode=w}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+u;break;case"scale":r.state.scale=y,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),g.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:fe(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:y,yScale:y})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:fe(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:y,yScale:y})}}return g.action==="end"&&(this.startAnimation(ca(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),g}).next(this._updateTooltipPipelineStep(l)),o.next(()=>{if(r.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(ca(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,e.events.on("focus-changed",n=>{n.action==="focus"?this.startAnimation(So(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),e.events.on("immediate-click",n=>{n.stopPropagation()}),$(()=>{var n;return(n=this.tool.graphicState)==null?void 0:n.displaying},n=>this._ringManipulator.available=n,xt)])}_updateTooltipPipelineStep(e){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const n=this._tooltip,s=this._tooltipOptions.visualVariables,o=c(s)?s.size:null,r=c(s)?s.rotation:null;switch(e.mode){case"scale":n.info=new $t({tooltipOptions:a,scale:{value:this.adapter.scale},size:Se(st(this.adapter.size,-1),"meters"),sizeUnit:c(o)?o.unit:null,sizePrecision:c(o)?De(o.valueType):null});break;case"rotate":{const l=c(r)?De(r.valueType):null,d=c(r)?r.rotationType:"geographic";n.info=new _t({tooltipOptions:a,rotation:ti(st(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:ti(-this.adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:d})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const e=this._tooltipOptions.visualVariables,i=c(e)?e.rotation:null,a=c(e)?e.size:null;this._tooltip.info=new Q({tooltipOptions:this._tooltipOptions,orientation:ti(-this.adapter.angle,"radians","geographic"),orientationEnabled:this.mode==null||this.mode==="rotate",orientationPrecision:c(i)?De(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:Se(st(this.adapter.size,-1),"meters"),sizeUnit:c(a)?a.unit:null,sizeEnabled:this.mode==null||this.mode==="scale",sizePrecision:c(a)?De(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(O.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(O.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut,!1),this._ringManipulator.updateStateEnabled(O.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(O.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(O.RotateLeft|O.RotateRight,!1),this._ringManipulator.updateStateEnabled(O.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(O.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut|O.RotateLeft|O.RotateRight,!1)}_updateManipulatorTransform(){const e=fa(J.get(),this.adapter.angle,X(0,0,1));if(v(e))return;const i=this.getScale(),a=ze(J.get(),ct(M.get(),i,i,i));this._ringManipulator.modelTransform=Ie(J.get(),a,e)}_createRingManipulator(){const e=(z,pt,Ot)=>{const wt=[],Tt=Math.ceil(za*(pt-z)/(2*Math.PI));for(let H=0;H<Tt+1;H++){const ce=z+H*(pt-z)/Tt;wt.push(X(Ot*Math.cos(ce),Ot*Math.sin(ce),0))}return wt},i=z=>e(0,2*Math.PI,z),a=z=>[[-z/2,0],[z/2,0],[z/2,ei/2],[-z/2,ei/2]],n=(z,pt)=>F.createPathExtrusionGeometry(a(pt),z,[],[],!1),s=i(Ft),o=n(s,ii),r={left:[],right:[]},l=[];for(let z=0;z<2;z++){const pt=z*Math.PI-Math.PI/4,Ot=Math.PI/2-io,wt=pt+Ot,Tt=pt+Math.PI/2-Ot,H=e(wt,Tt,Qs),ce=n(H,Kt);l.push(H),l.push(e(wt,Tt,Ki-ii/2)),r.left.push(ce),r.right.push(ce);for(let Je=0;Je<2;Je++){const xi=Je===0,q=Ye();if(xi){ba(q,q,[1,-1,1]),zi(q,q,-wt,[0,0,1]);const Nt=Math.round(Qi*(H.length-1));q[12]=H[Nt][0],q[13]=H[Nt][1],q[14]=H[Nt][2]}else{zi(q,q,Tt,[0,0,1]);const Nt=Math.round((1-Qi)*(H.length-1));q[12]=H[Nt][0],q[13]=H[Nt][1],q[14]=H[Nt][2]}const Ei=F.createExtrudedTriangle(to,0,eo,ei);F.transformInPlace(Ei,q),(xi?r.left:r.right).push(Ei)}}const d=[];for(let z=0;z<2;z++){const pt=z*Math.PI-Math.PI/4,Ot=Math.PI/2-ao,wt=pt+Ot,Tt=pt+Math.PI/2-Ot,H=e(wt,Tt,Ki);d.push(n(H,Kt))}const g=i(Ft+ta),m=i(Ft+ea),u=n(g,Kt),f=n(m,Kt),y=i(Ft-ta),b=i(Ft-ea),w=n(y,Kt),S=n(b,Kt),A=this._createMaterial(),j=this._createMaterial(.66),pe=this._createMaterial(.5),he=this._createMaterial(.33);let gt=[{geometry:o,material:A,stateMask:O.DelayedFocused},{geometry:o,material:pe,stateMask:x.None}];this.mode&&this.mode!=="scale"||(gt=gt.concat([{geometry:d,material:A,stateMask:O.DelayedFocused|O.Unlocked},{geometry:u,material:j,stateMask:O.DelayedFocused|O.ScaleIn},{geometry:f,material:he,stateMask:O.DelayedFocused|O.ScaleIn},{geometry:w,material:j,stateMask:O.DelayedFocused|O.ScaleOut},{geometry:S,material:he,stateMask:O.DelayedFocused|O.ScaleOut}])),this.mode&&this.mode!=="rotate"||(gt=gt.concat([{geometry:r.right,material:A,stateMask:O.DelayedFocused|O.Unlocked},{geometry:r.left,material:A,stateMask:O.DelayedFocused|O.RotateLeft},{geometry:r.right,material:A,stateMask:O.DelayedFocused|O.RotateRight}]));const we=[s,...l];return new et({view:this.tool.view,renderObjects:gt,autoScaleRenderObjects:!1,worldOriented:!0,radius:ii,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:k(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:we,direction:X(0,0,1)}})}_createMaterial(e=1){const i=Gn([...qs,e]);return new mi({color:i,transparent:e!==1,cullFace:ye.Back,renderOccluded:Lt.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function Mo(t,e){const i=L(M.get(),e.renderStart,t.origin),a=L(M.get(),e.renderEnd,t.origin),n=se(i),s=se(a);return n===0?0:s/n}function bo(t,e,i,a){const{renderStart:n,renderEnd:s}=t,o=Ge(n,a,M.get()),r=Ge(s,a,M.get());if(Dn(o,r)<Ji*Ji)return null;const l=L(M.get(),n,i),d=Vt(M.get(),l,xe(e)),g=n,m=It(M.get(),g,d),u=Ge(i,a,M.get()),f=o,y=Ge(m,a,M.get()),b=L(M.get(),y,f),w=L(M.get(),o,u),S=Li(f,b),A=Li(u,w);return Vi(S,r)<Vi(A,r)?"rotate":"scale"}function Ge(t,e,i){return e.projectToScreen(t,ai),ct(i,ai[0],ai[1],0)}function ca(t,e){let i=null,a=1;const n=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=n,e()},update:s=>(a+=((a+1)/2-a)*Math.min(s*so,1),e(),Math.abs(a-1)<.01?oe.STOP:oe.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function So(t,e){let i=0,a=null;const n=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=n,i=0,e()},update:s=>(i+=s,!a()||i>no?oe.STOP:oe.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}function De(t){switch(t){case"integer":case"long":return 0;default:return null}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(oe||(oe={}));const ai=Ze();function ka(t){return c(t.geometry)&&t.geometry.type==="mesh"?xo(t.geometry):Eo(t)}function xo(t){return c(t.transform)?Oo(t,t.transform):wo(t)}function Eo(t){let e=t.geometry,i=$n;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function Oo(t,e){let i=e.clone(),a=null;return{undo:n=>{a=c(t.transform)?t.transform.clone():null,t.transform=i,n.notifyGeometryChanged()},redo:n=>{i=c(t.transform)?t.transform.clone():null,t.transform=a,n.notifyGeometryChanged()}}}function wo(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}let vt=class extends yi{constructor(t){super(t),this.interactionState=null}initialize(){this.own([ne(()=>c(this.interactionState)&&this.interactionState.angle!==this.interactionState.previousAngle?{interactionState:this.interactionState,angle:this.interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},Ce),ne(()=>c(this.interactionState)&&this.interactionState.scale!==this.interactionState.previousScale?{interactionState:this.interactionState,scale:this.interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},Ce)])}get angle(){const t=this.geometry.transform;if(v(t))return 0;const e=vs(t.rotation)[2];return Math.abs(e)>.999999?Xe(ys(t.rotation))*Math.sign(e):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}startInteraction(){const t=new yt({angle:this.angle});this.interactionState=t;const e=()=>this.interactionState=null;return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return ka(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===li.Global,{angle:a,previousAngle:n}=t;this.geometry.rotate(0,0,fe(a-n),{origin:e,geographic:i}),t.previousAngle=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===li.Global,{scale:a,previousScale:n}=t;this.geometry.scale(a/n,{origin:e,geographic:i}),t.previousScale=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};p([h({constructOnly:!0})],vt.prototype,"graphic",void 0),p([h({constructOnly:!0})],vt.prototype,"geometry",void 0),p([h({constructOnly:!0})],vt.prototype,"viewingMode",void 0),p([h()],vt.prototype,"angle",null),p([h()],vt.prototype,"scale",null),p([h()],vt.prototype,"interactionState",void 0),vt=p([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],vt);let yt=class extends ui{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}cancel(){this.angle=this.initialAngle,this.scale=1}};p([h()],yt.prototype,"angle",void 0),p([h()],yt.prototype,"initialAngle",void 0),p([h()],yt.prototype,"previousAngle",void 0),p([h()],yt.prototype,"previousScale",void 0),p([h()],yt.prototype,"scale",void 0),p([h()],yt.prototype,"state",null),yt=p([V("InteractionState")],yt);let Z=class extends yi{constructor(t){super(t),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(ne(()=>c(this.interactionState)?this.interactionState.state:null,t=>{this._updateSymbol(t)},Ce))}get angle(){return c(this.interactionState)?this.interactionState.angle:c(this._orientationReferenceSymbolLayer)?To(this._orientationReferenceSymbolLayer.heading):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this.interactionState)?this.interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(v(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(v(e)||v(i)||i.type!=="point-3d")return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&c(a.size))return a.size;const n=this.sizeAxis;return"width"in a&&c(a.width)&&(v(n)||n==="width"||n==="all"||n==="width-and-depth")?a.width:"depth"in a&&c(t.depth)&&(v(n)||n==="depth"||n==="all"||n==="width-and-depth")?a.depth:"height"in a&&c(t.height)&&(v(n)||n==="height"||n==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return v(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return v(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&c(e.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(c(this.interactionState)||v(t)||v(e))return Ao;const i=t.symbolLayers.map(r=>r.type==="object"?e.getSymbolLayerSize(t,r):null).toArray(),a=t.clone(),n=this.angle,s=new ft({originalSymbol:a,angle:n,initialSizes:i});this.interactionState=s;const o=()=>this.interactionState=null;return{state:s,done:o,cancel:()=>{this._graphicSymbol=a,o()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const n=this._graphicSymbol;if(v(n)||n.type!=="point-3d")return;const s=n.clone(),o=-fe(e-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,s,(l,d,g)=>{const m=st(l.heading,0)+o;d.heading!==m&&(d.heading=m,r=!0);const u=a[g];if(c(u)&&"width"in u){u.width=this.sizeFilter(u.width),u.height=this.sizeFilter(u.height),u.depth=this.sizeFilter(u.depth);const f=u.width*t;d.width!==f&&(d.width=f,r=!0);const y=u.depth*t;d.depth!==y&&(d.depth=y,r=!0);const b=u.height*t;d.height!==b&&(d.height=b,r=!0)}}),r&&(this._graphicSymbol=s)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,n)=>{const s=e.symbolLayers.getItemAt(n);a.type==="object"&&s.type==="object"&&i(a,s,n)})}};function To(t){return-Xe(t)}p([h()],Z.prototype,"angle",null),p([h()],Z.prototype,"scale",null),p([h()],Z.prototype,"relativeAngle",null),p([h()],Z.prototype,"initialAngle",null),p([h()],Z.prototype,"size",null),p([h()],Z.prototype,"sizeAxis",void 0),p([h({constructOnly:!0})],Z.prototype,"graphic",void 0),p([h()],Z.prototype,"interactionState",void 0),p([h({constructOnly:!0})],Z.prototype,"findLayerView",void 0),p([h({constructOnly:!0})],Z.prototype,"sizeFilter",void 0),p([h()],Z.prototype,"_sizeReferenceSymbolLayer",null),p([h()],Z.prototype,"_orientationReferenceSymbolLayer",null),p([h()],Z.prototype,"_graphicSymbol",null),Z=p([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Z);const Ao={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let ft=class extends ui{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:n}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:n}}};p([h()],ft.prototype,"originalSymbol",void 0),p([h()],ft.prototype,"angle",void 0),p([h()],ft.prototype,"initialAngle",void 0),p([h()],ft.prototype,"initialSizes",void 0),p([h()],ft.prototype,"scale",void 0),p([h()],ft.prototype,"state",null),ft=p([V("InteractionState")],ft);let W=class extends Sa(kt.EventedMixin(je)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new ut,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new Ne,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new Wt({graphic:t}),this.own($(()=>this.tooltipOptions.enabled,a=>{this._tooltip=a?new Ee({view:e}):P(this._tooltip)},_i)),this._moveManipulation=new jt({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Bt(t),radius:jt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((a,n)=>this.handles.add([a.events.on("immediate-click",s=>{this.emit("immediate-click",R(G({},s),{graphic:t})),s.stopPropagation()}),a.events.on("focus-changed",({action:s})=>{const{tooltipOptions:o,_tooltip:r}=this;if(!v(r)&&(r.clear(),s==="focus")){const l=n===E.TRANSLATE_Z?rt:tt;r.info=new l({tooltipOptions:o})}})])),this._moveManipulation.elevationInfo=k(t);const i=t.geometry;if(this._moveManipulation.createGraphicDragPipeline((a,n,s,o,r)=>(c(i)&&a===D.XY&&(s=s.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new ke({elevationInfo:k(t),pointer:r,editGeometryOperations:qe.fromGeometry(new Rn({spatialReference:i.spatialReference}),e.state.viewingMode),visualizer:new be,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:o}),this._snappingPipeline.next)),s=s.next(l=>{const{tooltipOptions:d,_tooltip:g}=this;if(v(g))return l;const{mapStart:m,mapEnd:u}=l;g.clear();const f=a===D.Z?rt:tt;if(l.action==="end")g.info=new f({tooltipOptions:d});else{const y=a===D.Z?He(m,u):Me(m,u,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(y)&&(g.info=new f({tooltipOptions:d,distance:y}))}return l})),this.graphicState,a=>{const{action:n,graphic:s,dxScreen:o,dyScreen:r}=a,l={graphic:s,dxScreen:o,dyScreen:r};switch(n){case"start":this.emit("graphic-translate-start",l),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",l);break;case"end":this.emit("graphic-translate-stop",l)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add($(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const a=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new fo({tool:this,mode:a,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([We({view:this.view,graphic:this.graphic,forEachManipulator:a=>this._forEachManipulator(a),onManipulatorsChanged:()=>Yt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),$(()=>e.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(a=>{a instanceof et&&this.handles.add(a.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=P(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=P(this._scaleRotate),this._scaleRotateAdapter=P(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){v(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new vt({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Z({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return $(()=>this.graphicState.displaying,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Bt(this.graphic)})}_createGeometryUndoRecord(){return ka(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,c(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(v(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===li.Local||this.view.scale<oo?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Aa(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};p([h({constructOnly:!0,nonNullable:!0})],W.prototype,"view",void 0),p([h({constructOnly:!0,nonNullable:!0})],W.prototype,"graphic",void 0),p([h({constructOnly:!0,nonNullable:!0})],W.prototype,"enableZ",void 0),p([h()],W.prototype,"enableRotation",void 0),p([h()],W.prototype,"enableScaling",void 0),p([h({constructOnly:!0,type:ut})],W.prototype,"tooltipOptions",void 0),p([h()],W.prototype,"graphicState",void 0),p([h({value:!1})],W.prototype,"snapToScene",null),p([h({constructOnly:!0})],W.prototype,"snappingManager",void 0),p([h({readOnly:!0})],W.prototype,"type",void 0),p([h({readOnly:!0})],W.prototype,"updating",null),W=p([V("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],W);class Go{constructor(){this.lastDragEvent=null,this.next=new Ra,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i=R(G({},this.lastDragEvent),{action:"update"});e&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent=e.action!=="end"?G({},e):null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const i=Ia(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function $e(t,e){return Na(t,e,!1)}function da(t,e){return Na(t,e,!0)}function Na(t,e,i){if(t instanceof cs){if(t.operation instanceof ds)return Do(t.operation,e,i),!0;if(t.operation instanceof us)return $o(t.operation,e,i),!0;if(t.operation instanceof gs)return Ro(t.operation,e,i),!0}return!1}function Do(t,e,i=!1){const a=i?-1:1,n=X(a*t.dx,a*t.dy,a*t.dz);It(e.origin,e.origin,n)}function $o(t,e,i=!1){const a=i?-t.angle:t.angle;Ci(e.basis1,e.basis1,ki,a),Ci(e.basis2,e.basis2,ki,a)}function Ro(t,e,i=!1){const a=i?1/t.factor1:t.factor1,n=i?1/t.factor2:t.factor2;zt(e.basis1,e.basis1,a),zt(e.basis2,e.basis2,n),Ni(e.origin,e.origin,t.origin,t.axis1,a),Ni(e.origin,e.origin,t.origin,t.axis2,n)}function Io(t,e,i,a){a||(a=te());const n=Y(Qt.get(),t[1],-t[0]),s=Y(Qt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=Y(Qt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r=Qt.get();e.components.forEach(g=>g.vertices.forEach(m=>{const u=m.pos;Y(r,Hi(t,u),Hi(n,u)),Pn(s,s,r),zn(o,o,r)}));const l=1e-6,d=Y(Qt.get(),o[0]-s[0]<l?i/2:0,o[1]-s[1]<l?i/2:0);return Ta(s,s,d),Re(o,o,d),si(a.basis1,t,(o[0]-s[0])/2),si(a.basis2,n,(o[1]-s[1])/2),Y(a.origin,s[0]*t[0]+s[1]*n[0],s[0]*t[1]+s[1]*n[1]),Re(a.origin,a.origin,a.basis1),Re(a.origin,a.origin,a.basis2),a}function Po(t,e,i,a=0,n){n||(n=te()),e.toRenderCoords(t.origin,i,n.origin);const s=M.get();It(s,t.origin,t.basis1),It(s,s,t.basis2),e.toRenderCoords(s,i,s);const o=M.get();It(o,t.origin,t.basis1),L(o,o,t.basis2),e.toRenderCoords(o,i,o);const r=M.get();L(r,t.origin,t.basis1),L(r,r,t.basis2),e.toRenderCoords(r,i,r);const l=M.get();L(l,t.origin,t.basis1),It(l,l,t.basis2),e.toRenderCoords(l,i,l);const d=Zt(M.get(),s,o,.5);L(d,d,n.origin);const g=Zt(M.get(),r,l,.5);L(g,n.origin,g),Zt(n.basis1,d,g,.5);const m=Zt(M.get(),l,s,.5);L(m,m,n.origin);const u=Zt(M.get(),o,r,.5);L(u,n.origin,u),Zt(n.basis2,m,u,.5);const f=Vt(M.get(),n.basis1,n.basis2),y=Vt(f,f,n.basis1);return Le(y,y),zt(n.basis2,y,Ve(n.basis2,y)),zt(n.basis1,n.basis1,1+a/se(n.basis1)),zt(n.basis2,n.basis2,1+a/se(n.basis2)),In(n),n}function ua(t,e,i,a){const n=M.get();L(n,L(n,t.origin,t.basis1),t.basis2);const s=M.get();Xt(s,n,t.basis1,2);const o=M.get();Xt(o,s,t.basis2,2);const r=M.get();Xt(r,n,t.basis2,2),n[2]=s[2]=o[2]=r[2]=e;const l=a?"on-the-ground":"absolute-height",d=Yi(Te(n,s,i,l),Te(r,o,i,l)),g=Yi(Te(s,o,i,l),Te(n,r,i,l));return v(g)||v(d)?null:[d,g]}let me=class extends Et{constructor(t){super(t),this.type="extent-rotate",this.angle=0}};p([h()],me.prototype,"type",void 0),p([h()],me.prototype,"angle",void 0),me=p([V("esri.views.interactive.tooltip.ExtentRotateTooltipInfo")],me);let Rt=class extends Et{constructor(t){super(t),this.type="extent-scale",this.xScale=0,this.yScale=0,this.xSize=Ct,this.ySize=Ct}};p([h()],Rt.prototype,"type",void 0),p([h()],Rt.prototype,"xScale",void 0),p([h()],Rt.prototype,"yScale",void 0),p([h()],Rt.prototype,"xSize",void 0),p([h()],Rt.prototype,"ySize",void 0),Rt=p([V("esri.views.interactive.tooltip.ExtentScaleTooltipInfo")],Rt);let K=class extends kt.EventedMixin(je){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new ut,this._preserveAspectRatio=new Go,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new re,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=te(),this.mapBoundsStart=te(),this.zmax=0,this.sizeStart=null,this.displayBounds=te(),this.displayBoundsStart=te(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=_e(),this._endScale=_e()}initialize(){const{view:t,graphic:e,manipulators:i,handles:a}=this,n=this.graphicState=new Wt({graphic:e}),s=e.geometry;this.editGeometryOperations=qe.fromGeometry(s,t.state.viewingMode),this.graphicMoveManipulation=new Si({tool:this,view:t,graphicState:n}),this.moveZManipulator=fs(t,Ms.CENTER_ON_CALLOUT),this.moveZManipulator.state|=bs,a.add([this._createMoveXYGraphicDragPipeline(),$(()=>this.enableZ,()=>this._updateManipulatorAvailability(this.moveZManipulator,E.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(g=>{const m=Ss(t,g);return a.add([$(()=>this.enableScaling,()=>this._updateManipulatorAvailability(m,E.SCALE)),m.events.on("grab-changed",u=>this._onResizeGrab(u)),this._createResizeDragPipeline(m,g)]),m}),i.addMany(this.resizeManipulators),this.rotateManipulatorTexture=xs(t.toolViewManager.textures),this.rotateManipulator=Es(t,this.rotateManipulatorTexture.texture),a.add([$(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this.rotateManipulator,E.ROTATE)),this.rotateManipulator.events.on("grab-changed",g=>{this._onRotateGrab(g)}),this._createRotateDragPipeline(this.rotateManipulator)]),i.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const o=We({view:t,graphic:e,forEachManipulator:g=>this._forEachManipulator(g),onManipulatorsChanged:()=>Yt()});c(o)&&(this.outlineVisualElement=o.visualElement instanceof qt?o.visualElement:null),c(this.outlineVisualElement)&&a.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(o),a.add([n.on("changed",()=>this._onGeometryChanged()),$(()=>n.displaying,()=>this._updateAllManipulatorAvailability()),$(()=>n.isDraped,()=>this._graphicDrapedChanged(),xt),t.trackGraphicState(n)]);const r=t.pointsOfInterest;r&&a.add($(()=>r.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=g=>{a.add(g.events.on("grab-changed",()=>{this.grabbing=g.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const d=(g,m)=>{a.add(g.events.on("immediate-click",u=>{m===E.TRANSLATE_XY&&this.emit("immediate-click",R(G({},u),{graphic:e})),u.stopPropagation()}))};this._forEachManipulator(d),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{handles:t,view:e}=this,i=this._tooltip=new Ee({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",n=>{this._startAngle=n.angle,a()}),this.on("graphic-rotate",n=>{this._endAngle=n.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",n=>{Y(this._startScale,n.xScale,n.yScale),Y(this._endScale,n.xScale,n.yScale),a()}),this.on("graphic-scale",n=>{Y(this._endScale,n.xScale,n.yScale),a()}),this.on("graphic-scale-stop",()=>{Y(this._startScale,0,0),Y(this._endScale,0,0),a()})]),this._forEachManipulator(n=>{t.add([n.events.on("focus-changed",a),n.events.on("grab-changed",a),n.events.on("drag",s=>{s.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this.graphicMoveManipulation.grabbing||this.graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():this.rotateManipulator.focused?this._computeRotateTooltipInfo():this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=st(this._moveXYTooltipInfo,()=>new tt({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=st(this._moveZTooltipInfo,()=>new rt({tooltipOptions:this.tooltipOptions})),e=this._moveUnit;if(this.moveZManipulator.dragging){const i=this.mapBoundsStart.origin,a=this.mapBounds.origin,n=_s(i,a,this.view.spatialReference);if(v(n))return null;t.distance=n}else t.distance=Se(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=st(this._rotateTooltipInfo,()=>new me({tooltipOptions:this.tooltipOptions}));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(v(t))return null;const e=this._scaleTooltipInfo=st(this._scaleTooltipInfo,()=>new Rt({tooltipOptions:this.tooltipOptions})),i=ua(this.mapBounds,this.zmax,t.spatialReference,this.graphicState.isDraped);return v(i)?null:(e.xSize=i[0],e.ySize=i[1],c(this.sizeStart)&&this.resizeManipulators.some(a=>a.dragging)?(e.xScale=i[0].value/this.sizeStart[0].value,e.yScale=i[1].value/this.sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this.handles.remove(ga),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",t=>{c(this.attachmentOrigin)&&ya(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),ga)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof et){const a=this.graphicState.displaying,n=this.enableZ&&Bt(this.graphic);switch(e){case E.ROTATE:t.available=a&&this.enableRotation;break;case E.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||n),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?Os:ws;break;case E.TRANSLATE_Z:t.available=a&&n;break;default:t.available=a}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach(e=>t(e,E.SCALE)),t(this.rotateManipulator,E.ROTATE),t(this.moveZManipulator,E.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return st(Ln(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,i=e.components[0].edges[0],a=Ta(Qt.get(),i.leftVertex.pos,i.rightVertex.pos);ni(a,a);const n=st(pi(this.view,this.graphic),()=>t.extent.center);let s=Lo*this.view.pixelSizeAt(n);const o=this.view.spatialReference,r=t.spatialReference;o.equals(r)||(s*=ri(o)/ri(r)),Io(a,e,s,this.mapBounds),this._calculateZMax()}_calculateZMax(){const t=this.editGeometryOperations.data;if(!t.geometry.hasZ)return void(this.zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const n of a.vertices){const s=e.getZ(n.pos);i=Math.max(s,i)}this.zmax=i}_updateDisplayBounds(){const t=this.graphic.geometry;if(v(t))return;const e=c(this.outlineVisualElement)&&!this.graphicState.isDraped&&c(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:pi(this.view,this.graphic);this.attachmentOrigin=st(e,t.extent.center);const i=c(e)?e.z:va(this.mapBounds.origin,this.view.elevationProvider,gi.fromElevationInfo(k(this.graphic)),this.view.renderCoordsHelper),a=At(this.mapBounds);a.origin[2]=i,Po(a,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return zo*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i,D.XY))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return lt(this.moveZManipulator,(i,a,n)=>{const s=wa(i.renderLocation),o=a.next($a(t,s,e)).next(le());this._applyGraphicMoveSteps(o,n,D.Z)})}_applyGraphicMoveSteps(t,e,i){const a=t.next(n=>(n.action==="start"&&(this.inputState={type:"move"},At(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:n.screenDeltaX,dyScreen:n.screenDeltaY})),n)).next(ee()).next(this._moveDragUpdateGeometry()).next(n=>{const s={graphic:this.graphic,dxScreen:n.screenDeltaX,dyScreen:n.screenDeltaY};switch(n.action){case"start":case"update":(n.mapEnd.x-n.mapStart.x||n.mapEnd.y-n.mapStart.y||n.mapEnd.z-n.mapStart.z)&&this.emit("graphic-translate",s);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",s)}return n}).next(n=>this._updateMoveTooltip(n,i));return e.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_calculateSizeStart(){v(this.graphic.geometry)?this.sizeStart=null:this.sizeStart=ua(this.mapBoundsStart,this.zmax,this.graphic.geometry.spatialReference,this.graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(v(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const n of this.editGeometryOperations.data.components)e.push(...n.vertices);const i=t.action==="start"?bt.NEW_STEP:bt.ACCUMULATE_STEPS,a=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return $e(a,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===D.XY||e===D.XY_AXIS){const i=Me(t.mapStart,t.mapEnd,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return t}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);Ui(this.displayBounds.plane,e,M.get())&&(At(this.displayBounds,this.displayBoundsStart),At(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return lt(t,(i,a,n)=>{v(this.inputState)||(a.next(s=>(s.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),s)).next(ci(this.view,this.displayBoundsStart.plane)).next(s=>R(G({},s),{handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(s=>{const o={graphic:this.graphic,xScale:s.factor1,yScale:s.factor2};switch(s.action){case"start":case"update":this.emit("graphic-scale",o);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",o)}return s}),n.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,i=t.handle.direction,a=this.displayBoundsMargin,n=this.displayBoundsMarginStart,s=Qe(M.get(),e.origin);Xt(s,s,e.basis1,-i[0]),Xt(s,s,e.basis2,-i[1]);const o=L(M.get(),t.renderEnd,s),r=L(M.get(),t.renderStart,s),l=Ia(t.handle),d=Bi(e),g=Bi(this.displayBounds)/d,m=(u,f)=>{if(u===0)return 1;let y=se(f),b=.5*u*Ve(f,o)/y;const w=b<0?-1:1;l&&(b+=(y-.5*u*Ve(f,r)/y)*w*g);const S=y<1.5*n?1:ma;return y=Math.max(y-n,ma),w>0&&(b-=a),w*Math.max(w*(b/y),S)};return R(G({},t),{factor1:m(i[0],e.basis1),factor2:m(i[1],e.basis2)})}}_resizeDragUpdateGeometry(){return t=>{const e=Qe(N(),this.mapBoundsStart.origin);Xt(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),Xt(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=Y(_e(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);ni(i,i);const a=[];for(const o of this.editGeometryOperations.data.components)a.push(...o.vertices);const n=t.action==="start"?bt.NEW_STEP:bt.ACCUMULATE_STEPS,s=this.editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,n,Xi.REPLACE);return At(this.mapBoundsStart,this.mapBounds),$e(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=Ts(this.displayBounds,this.view.renderCoordsHelper,As.HEADING,vi()),i=this._calculatePickRay(t.screenPoint);Ui(e,i,M.get())&&(At(this.displayBounds,this.displayBoundsStart),At(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return lt(t,(e,i,a)=>{const n=this.inputState;v(n)||(i.next(s=>(s.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),s)).next(ci(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdateGeometry()).next(s=>{const o={graphic:this.graphic,angle:fe(s.rotateAngle)};switch(s.action){case"start":case"update":this.emit("graphic-rotate",o);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",o)}return s}),a.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=xe(t.rotatePlane),a=Ga(e.renderStart,e.renderEnd,this.displayBounds.origin,i);return R(G({},e),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdateGeometry(){return t=>{const e=Qe(N(),this.mapBoundsStart.origin),i=[];for(const s of this.editGeometryOperations.data.components)i.push(...s.vertices);const a=t.action==="start"?bt.NEW_STEP:bt.ACCUMULATE_STEPS,n=this.editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,Xi.REPLACE);return At(this.mapBoundsStart,this.mapBounds),$e(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Vn(),i=Cn(t);return kn(this.view.state.camera,i,e),Le(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=Gs(this.displayBounds,J.get());Ds(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach((e,i)=>{$s(e,this.resizeHandles[i],t,this.displayBounds)})}_updateZMoveHandle(t,e){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:L(M.get(),i.origin,i.basis1),edge:2},n=J.get();Nn(n,e,a.edge*Math.PI/2),n[12]=0,n[13]=0,n[14]=0,t.modelTransform=n,t.renderLocation=a.position}_cancel(){const t=this.editGeometryOperations.lastOperation;v(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,da(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,da(T(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,$e(T(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator,tooltip:this._tooltip}}};p([h({constructOnly:!0,nonNullable:!0})],K.prototype,"view",void 0),p([h({constructOnly:!0,nonNullable:!0})],K.prototype,"graphic",void 0),p([h({constructOnly:!0,nonNullable:!0})],K.prototype,"enableZ",void 0),p([h()],K.prototype,"enableRotation",void 0),p([h()],K.prototype,"enableScaling",void 0),p([h({constructOnly:!0,type:ut})],K.prototype,"tooltipOptions",void 0),p([h()],K.prototype,"preserveAspectRatio",null),p([h()],K.prototype,"grabbing",void 0),p([h()],K.prototype,"inputState",void 0),p([h({readOnly:!0})],K.prototype,"type",void 0),p([h()],K.prototype,"_moveUnit",null),K=p([V("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],K);const ga="draped-elevation-changes",zo=10,Lo=80,ma=1e-6;export{Gt as DrawGraphicTool3D,K as ExtentTransformTool,mt as GraphicMoveTool,U as GraphicReshapeTool,W as GraphicTransformTool};
