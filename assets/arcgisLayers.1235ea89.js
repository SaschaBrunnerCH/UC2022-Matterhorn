var F=Object.defineProperty,C=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var L=(e,a,r)=>a in e?F(e,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[a]=r,f=(e,a)=>{for(var r in a||(a={}))U.call(a,r)&&L(e,r,a[r]);if(v)for(var r of v(a))J.call(a,r)&&L(e,r,a[r]);return e},d=(e,a)=>C(e,N(a));import{F as p,cK as M,I as O,aU as V,cL as x,cM as j,cm as k,bN as E}from"./vendor.508dc62e.js";import{a as A}from"./lazyLayerLoader.9672059f.js";async function W(e){var l;const a=(l=e.properties)==null?void 0:l.customParameters,r=await K(e.url,a),t=d(f({},e.properties),{url:e.url});if(!r.sublayerIds)return r.layerOrTableId!=null&&(t.layerId=r.layerOrTableId,t.sourceJSON=r.sourceJSON),new r.Constructor(t);const s=new(await import("./GroupLayer.db5445a5.js")).default({title:r.parsedUrl.title});return B(s,r,t),s}function P(e,a){return e?e.find(r=>r.id===a):null}function B(e,a,r){function t(s,l){const o=d(f({},r),{layerId:s,sublayerTitleMode:"service-name"});return p(l)&&(o.sourceJSON=l),new a.Constructor(o)}a.sublayerIds.forEach(s=>{const l=t(s,P(a.sublayerInfos,s));e.add(l)}),a.tableIds.forEach(s=>{const l=t(s,P(a.tableInfos,s));e.tables.add(l)})}async function K(e,a){var S,b;let r=M(e);if(O(r)&&(r=await R(e,a)),O(r))throw new V("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:t,sublayer:s}=r;let l;const o={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(t){case"MapServer":l=s!=null?"FeatureLayer":G(e,a).then(n=>n?"TileLayer":"MapImageLayer");break;case"ImageServer":l=c(e,{customParameters:a}).then(n=>{const i=n.tileInfo&&n.tileInfo.format;return n.tileInfo?(i==null?void 0:i.toUpperCase())!=="LERC"||n.cacheType&&n.cacheType.toLowerCase()!=="elevation"?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"});break;case"SceneServer":l=c(r.url.path,{customParameters:a}).then(n=>{var i;if(n){if((n==null?void 0:n.layerType)==="Voxel")return"VoxelLayer";if((n==null?void 0:n.layers)&&Array.isArray(n.layers)&&n.layers.length>0){const w={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"},h=(i=n.layers[0])==null?void 0:i.layerType;if(w[h]!=null)return w[h]}}return"SceneLayer"});break;default:l=o[t]}const u={FeatureLayer:!0,SceneLayer:!0},m=t==="FeatureServer",y={parsedUrl:r,Constructor:null,layerOrTableId:m?s:null,sublayerIds:null,tableIds:null},I=await l;if(u[I]&&s==null){const n=await q(e,t,a);m&&(y.sublayerInfos=n.layerInfos,y.tableInfos=n.tableInfos),n.layerIds.length+n.tableIds.length!==1?(y.sublayerIds=n.layerIds,y.tableIds=n.tableIds):m&&(y.layerOrTableId=(S=n.layerIds[0])!=null?S:n.tableIds[0],y.sourceJSON=(b=n.layerInfos[0])!=null?b:n.tableInfos[0])}return y.Constructor=await D(I),y}async function R(e,a){var u;const r=await c(e,{customParameters:a});let t=null,s=null;const l=r.type;if(l==="Feature Layer"||l==="Table"?(t="FeatureServer",s=r.id):l==="indexedVector"?t="VectorTileServer":r.hasOwnProperty("mapName")?t="MapServer":r.hasOwnProperty("bandCount")&&r.hasOwnProperty("pixelSizeX")?t="ImageServer":r.hasOwnProperty("maxRecordCount")&&r.hasOwnProperty("allowGeometryUpdates")?t="FeatureServer":r.hasOwnProperty("streamUrls")?t="StreamServer":T(r)?(t="SceneServer",s=r.id):r.hasOwnProperty("layers")&&T((u=r.layers)==null?void 0:u[0])&&(t="SceneServer"),!t)return null;const o=s!=null?x(e):null;return{title:p(o)&&r.name||j(e),serverType:t,sublayer:s,url:{path:p(o)?o.serviceUrl:k(e).path}}}function T(e){return(e==null?void 0:e.hasOwnProperty("store"))&&e.hasOwnProperty("id")&&typeof e.id=="number"}async function q(e,a,r){let t,s=!1;if(a==="FeatureServer"){const u=await z(e,{customParameters:r});s=!!u.layersJSON,t=u.layersJSON||u.serviceJSON}else t=await c(e,{customParameters:r});const l=t==null?void 0:t.layers,o=t==null?void 0:t.tables;return{layerIds:(l==null?void 0:l.map(u=>u.id).reverse())||[],tableIds:(o==null?void 0:o.map(u=>u.id).reverse())||[],layerInfos:s?l:[],tableInfos:s?o:[]}}function g(e){return!e.type||e.type==="Feature Layer"}async function z(e,a){var l,o;let r=await c(e,a);r=r||{},r.layers=((l=r.layers)==null?void 0:l.filter(g))||[];const t={serviceJSON:r};if(r.currentVersion<10.5)return t;const s=await c(e+"/layers",a);return t.layersJSON={layers:((o=s==null?void 0:s.layers)==null?void 0:o.filter(g))||[],tables:(s==null?void 0:s.tables)||[]},t}async function D(e){return(0,A[e])()}async function G(e,a){return(await c(e,{customParameters:a})).tileInfo}async function c(e,a){return(await E(e,{responseType:"json",query:d(f({f:"json"},a==null?void 0:a.customParameters),{token:a==null?void 0:a.apiKey})})).data}export{z as fetchFeatureService,W as fromUrl};
