var Te=Object.defineProperty,Se=Object.defineProperties;var Ce=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var Y=(e,t,i)=>t in e?Te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,X=(e,t)=>{for(var i in t||(t={}))xe.call(t,i)&&Y(e,i,t[i]);if(J)for(var i of J(t))ke.call(t,i)&&Y(e,i,t[i]);return e},ee=(e,t)=>Se(e,Ce(t));import{at as $e,B as l,D as r,E as R,F as Z,y as L,a2 as te,nw as Le,_ as w,b4 as F,M as h,H as n,nx as y,ny as Re,mB as He,au as ze,av as Ie,$ as Ge,a7 as q,fK as ie,Q as g,nt as M,nz as d,m5 as $,g7 as S,nA as j,fG as E,kU as ae,aB as se,lp as c,b8 as I,b7 as ne,nB as le,iT as N,l0 as Oe,nC as Ae,mq as T,eI as re,lq as Be,kc as G,eG as Ke,aV as oe,l$ as Ue,m3 as he,m4 as Fe,mw as qe,b5 as ye,nD as _e,f9 as ve,aE as Q,lo as je,kw as Ne,nE as Qe,bi as We}from"./vendor.fe24faac.js";import{n as Ze}from"./AnalysisView3D.2030e592.js";import{V as Je,R as Ye,A as Xe,T as we,h as Pe,p as et,o as tt,i as it,u as at,d as ue,g as st,a as ge,m as me,b as fe,c as O,e as A,K as pe,L as de,W as nt,l as lt,q as rt,P as C,Y as ot,M as f,J as Ve,Q as ht,r as ut,f as pt,t as dt,C as b,S as D,$ as ct,k as yt,j as _t,x as vt,U as wt}from"./Factory.9dab653f.js";import{E as Pt}from"./BuildingComponentSublayer.c8e3f1f1.js";import{a as gt}from"./projectionUtils.485a4050.js";import{O as mt}from"./manipulatorUtils.5d13d6ff.js";import{C as x}from"./dragEventPipeline3D.bea38d6a.js";import{a as ft,c as Vt,m as Mt}from"./analysisViewUtils.628b018a.js";import{p as k}from"./InteractiveToolBase.e7b97dce.js";import"./LineVisualElement.3ebffa56.js";import"./Object3DVisualElement.aec1ab10.js";import"./ImageMaterial.885a8679.js";import"./drawUtils.f401567c.js";const B=$e.getLogger("esri.views.3d.analysis.Slice.SliceController");let P=class extends Z{constructor(e){super(e),this._handles=new L,this._internalChange=!1,this._currentSlicePlane=null,this.state="ready"}get ready(){return this.state==="ready"}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof te||t instanceof Pt)?t instanceof te&&Le(t)?(B.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(B.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),Dt(this.view,this),this._handles.add([w(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),w(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),w(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),w(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([w(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.state!=="destroyed"&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),Et(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await F(()=>this.ready),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(Je).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(h(t)&&h(e)||n(t)&&n(e)&&e.equals(t))return;let i=null,a=null;if(n(e)&&n(e.position)){const s=e.position.spatialReference,o=Ye(e,this.view);h(o)&&gt(this.analysis,s,B),i=Xe(o,this.view,{tiltEnabled:this.analysis.tiltEnabled},y()),n(i)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=we(e,this.view,this.view.spatialReference,new Pe);let i=null;n(t)&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(K)return;const e=Me(this.view);if(this.analysisViewData.active)n(e.activeController)&&e.activeController!==this?(K=!0,e.activeController.analysisViewData.active=!1,K=!1):n(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(n(e.activeController)&&e.activeController!==this)return;n(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){this.state==="ready"&&bt(this.view)}_updateLayerViews(){const e=n(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};l([r({readOnly:!0})],P.prototype,"state",void 0),l([r()],P.prototype,"view",void 0),l([r()],P.prototype,"analysis",void 0),l([r()],P.prototype,"analysisViewData",void 0),l([r()],P.prototype,"ready",null),l([r()],P.prototype,"_allLayerAndSubLayerViews",null),P=l([R("esri.views.3d.analysis.Slice.SliceController")],P);const m=new Map;let K=!1;function bt(e){const t=Me(e).activeController;n(t)&&n(t.analysisViewData.plane)&&t.analysisViewData.visible?e.slicePlane=t.analysisViewData.plane:e.slicePlane=null}function Dt(e,t){m.has(e)||m.set(e,{all:[],activeController:null}),m.get(e).all.push(t)}function Me(e){return m.get(e)}function Et(e,t){if(!m.has(e))throw new Error("view expected in global slice register");const i=m.get(e),a=i.all.lastIndexOf(t);if(a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&m.delete(e)}var W;let u=W=class extends ft{constructor(e){super(e),this.clock=Re,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new L,this._viewHandles=new L,this._frameTask=null,this._pointerMoveTimerMs=et,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=y(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=He(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ze(e.view.state.viewingMode),this._intersector.options.store=Ie.MIN}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.rotateHeadingImage=tt(this.view.toolViewManager.textures),this.rotateTiltImage=it(this.view.toolViewManager.textures);const e=i=>{this._updateManipulatorsInteractive(i),i.grabbing||(n(this.analysisViewData.plane)&&d(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=at(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),e(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=ue(this.view,this.rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),e(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=ue(this.view,this.rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),e(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=st(this.view,i);return s.events.on("grab-changed",o=>{this._onResizeGrab(o,a),e(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ge(this.view),this._previewPlaneOutlineVisualElement=me(this.view),this._previewPlaneOutlineVisualElement.width=fe,this._handles.add(w(()=>this.analysisViewData.plane,()=>this._updateManipulators(),Ge));const t=w(()=>this.state,i=>{i==="sliced"&&this.finishToolCreation()},q);this._handles.add([t,w(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this.rotateHeadingImage=ie(this.rotateHeadingImage),this.rotateTiltImage=ie(this.rotateTiltImage),this._handles=g(this._handles),this._viewHandles=g(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=g(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=g(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":n(this._creatingPointerId)?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=n(e)&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return n(this.inputState)&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){h(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){h(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this.shiftManipulator&&(this._updateManipulators(),e||this._clearPointerMoveTimeout())}onInputEvent(e){switch(e.type){case"pointer-drag":if(!U(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!U(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!U(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.editable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&n(t)&&t.type==="shift"){const i=M(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(M(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&n(this.analysisViewData.plane)){const t=M(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),d(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=M(e),i=y();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(d(i,this._startPlane),this.analysis.shape=we(i,this.view,this.view.spatialReference,new Pe),e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=ce(a,e.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(M(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===O||e.key===A)&&(this._activeKeyModifiers[e.key]=!0,n(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==O&&e.key!==A||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],n(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||h(this.analysisViewData.plane))return;const t=this._calculatePickRay(e.screenPoint);d(this.analysisViewData.plane,this._startPlane),this.inputState=ce(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return k(e,(t,i,a)=>{const s=this.inputState;if(h(s)||s.type!=="shift")return;const o=n(this.analysisViewData.plane)?d(this.analysisViewData.plane,y()):null;i.next(x(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{n(o)&&this._updateBoundedPlane(o)})})}_shiftDragAdjustSensitivity(e){return t=>{if(h(this.analysisViewData.plane))return null;const i=.001,a=Math.min((1-Math.abs(S(j(this.analysisViewData.plane),t.ray.direction)/E(t.ray.direction)))/i,1),s=-ae(this._startPlane.plane,t.renderEnd),o=-ae(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-o,t}}_shiftDragUpdatePlane(e){return()=>{if(h(this.analysisViewData.plane))return;const t=se(c.get(),this._startPlane.origin),i=se(c.get(),j(this._startPlane));I(i,i,-e.depth),ne(i,i,t);const a=le(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,y());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||h(this.analysisViewData.plane))return;const t=pe(this.analysisViewData.plane,this.view.renderCoordsHelper,de.HEADING,N()),i=this._calculatePickRay(e.screenPoint),a=Q();$(t,i,a)&&(d(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return k(e,(t,i,a)=>{const s=this.inputState;if(h(s)||s.type!=="rotate")return;const o=n(this.analysisViewData.plane)?d(this.analysisViewData.plane,y()):null;i.next(x(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n(o)&&this._updateBoundedPlane(o)})})}_onRotateTiltGrab(e){if(e.action!=="start"||h(this.analysisViewData.plane))return;const t=pe(this.analysisViewData.plane,this.view.renderCoordsHelper,de.TILT,N()),i=this._calculatePickRay(e.screenPoint),a=Q();$(t,i,a)&&(d(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return k(e,(t,i,a)=>{const s=this.inputState;if(h(s)||s.type!=="rotate")return;const o=n(this.analysisViewData.plane)?d(this.analysisViewData.plane,y()):null;i.next(x(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n(o)&&this._updateBoundedPlane(o)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(h(this.analysisViewData.plane))return null;const i=Oe(e.rotatePlane),a=mt(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return ee(X({},t),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(h(this.analysisViewData.plane))return;const t=Ae(T.get(),e.rotateAngle,e.rotateAxis);if(h(t))return;const i=re(c.get(),this._startPlane.basis1,t),a=re(c.get(),this._startPlane.basis2,t),s=le(this.analysisViewData.plane.origin,i,a,y());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||h(this.analysisViewData.plane))return;const i=this._calculatePickRay(e.screenPoint),a=c.get();$(this.analysisViewData.plane.plane,i,a)&&(d(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Be(a)})}_createResizeDragPipeline(e){return k(e,(t,i,a)=>{const s=this.inputState;if(h(s)||s.type!=="resize"||h(this.analysisViewData.plane))return;const o=d(this.analysisViewData.plane,y());i.next(x(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(o)})})}_resizeDragUpdatePlane(e){return t=>{if(h(this.analysisViewData.plane))return;const i=this._resizeHandles[e.activeHandleIdx],a=nt(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,d(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(!n(t))throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,h(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=n(i)?i:y();if(i=n(i)?d(i,Tt):null,this._pickPlane(e,!0,t,a)){const s=yt;let o=!1;n(i)&&(o=S(i.plane,a.plane)<s||S(G(c.get(),i.basis1),G(c.get(),a.basis1))<s),o&&(this._previewPlaneOpacity=0),this._previewPlane=a}}n(this._previewPlane)&&h(this._frameTask)&&this._previewPlaneOpacity===0?this._frameTask=Ke({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*lt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):h(this._previewPlane)&&n(this._frameTask)?this._removeFrameTask():n(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=oe(this._frameTask)}_calculatePickRay(e){const t=Ue(),i=he(e,St);return Fe(this.view.state.camera,i,t),G(t.direction,t.direction),t}_pickMinResult(e){const t=he(e,qe.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),o=c.get();if(!s.getIntersectionPoint(o))return!1;const p=s.getTransformedNormal(c.get()),V=this.view.state.camera;S(p,V.viewForward)>0&&I(p,p,-1);const H=rt(o,V),be=(t?1:-1)*H*_t,z=I(c.get(),p,be);ne(z,z,o);const De=this.analysis.tiltEnabled?C.TILTED:C.HORIZONTAL_OR_VERTICAL,Ee=i[O]?C.VERTICAL:i[A]?C.HORIZONTAL:De;return ot(z,p,H,H,V,Ee,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=oe(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this.clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(W.disableEngineLayers)return;let e=null,t=!1;if(n(this.analysisViewData.plane))e=this.analysisViewData.plane,t=!1;else{if(!n(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=Ve(e,T.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(p=>p.available=!0),ht(this.shiftManipulator,i,e,this.view.state.camera),ut(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),pt(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((p,V)=>dt(p,this._resizeHandles[V],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=ye(c.get(),E(e.basis1),E(e.basis2),1),s=_e(T.get(),a),o=ve(s,i,s);this._previewPlaneOutlineVisualElement.transform=o,this._previewPlaneGridVisualElement.transform=o,this._updateMaterials()}_updateMaterials(){const e=[b[0],b[1],b[2],b[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=e;const t=[D[0],D[1],D[2],D[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=i}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function ce(e,t,i,a){const s=ct(i,j(a),e.direction,N()),o=Q();return $(s,e,o)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:o}:null}function U(e){return e.pointerType!=="mouse"||e.button===0}u.disableEngineLayers=!1,l([r()],u.prototype,"clock",void 0),l([r({constructOnly:!0})],u.prototype,"view",void 0),l([r()],u.prototype,"analysisViewData",void 0),l([r({readOnly:!0})],u.prototype,"state",null),l([r({readOnly:!0})],u.prototype,"cursor",null),l([r()],u.prototype,"analysis",null),l([r()],u.prototype,"removeIncompleteOnCancel",void 0),l([r({readOnly:!0})],u.prototype,"layersMode",void 0),l([r({value:null})],u.prototype,"inputState",null),l([r()],u.prototype,"_isPlacingSlicePlane",null),l([r()],u.prototype,"_creatingPointerId",null),u=W=l([R("esri.views.3d.analysis.Slice.SliceTool")],u);const Tt=y(),St=je(),Ct=u;let _=class extends Z{constructor(e){super(e),this._handles=new L,this._gridVisualElement=null,this._outlineVisualElement=null,this.state="pending",this.showGrid=!1,this.preview=!0}get ready(){return this.state==="ready"}initialize(){this._initialize()}async _initialize(){if(this.state==="destroyed"||this.state==="ready")return;await F(()=>this.view.ready);const e=this.analysisViewData;if(h(e))throw new Error("expected internal object to be valid");this._gridVisualElement=ge(this.view),this._outlineVisualElement=me(this.view),this._handles.add([w(()=>({visible:n(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),q),w(()=>e.plane,t=>this._updatePlane(t),q)],"internal"),this._set("state","ready")}destroy(){this.state!=="destroyed"&&this.state!=="pending"&&(this._handles.destroy(),this._gridVisualElement=g(this._gridVisualElement),this._outlineVisualElement=g(this._outlineVisualElement),this.set("view",null),this._set("state","destroyed"))}async whenReady(){await F(()=>this.view.ready)}_updatePlane(e){if(h(e))return;const t=ye(c.get(),E(e.basis1),E(e.basis2),1),i=_e(T.get(),t),a=Ve(e,T.get()),s=ve(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=b,this._outlineVisualElement.width=i?fe:vt,this._outlineVisualElement.stipplePattern=t?null:Ne(5),this._gridVisualElement.backgroundColor=D,this._gridVisualElement.gridColor=a?wt:Qe,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};l([r({readOnly:!0})],_.prototype,"state",void 0),l([r()],_.prototype,"view",void 0),l([r()],_.prototype,"analysis",void 0),l([r()],_.prototype,"analysisViewData",void 0),l([r()],_.prototype,"ready",null),l([r()],_.prototype,"showGrid",void 0),l([r()],_.prototype,"preview",void 0),_=l([R("esri.views.3d.analysis.Slice.SliceVisualization")],_);let v=class extends Ze(Z){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0,this.showGrid=!1}initialize(){this.analysisVisualization=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new P({view:this.view,analysis:this.analysis,analysisViewData:this}),this.own(Vt(this,Ct))}destroy(){Mt(this),this.analysisVisualization=g(this.analysisVisualization),this.analysisController=g(this.analysisController)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}async when(){return await this.analysisVisualization.whenReady(),await this.analysisController.whenReady(),this}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:We(this.tool)}}};l([r({readOnly:!0})],v.prototype,"type",void 0),l([r({constructOnly:!0,nonNullable:!0})],v.prototype,"analysis",void 0),l([r()],v.prototype,"tool",void 0),l([r()],v.prototype,"plane",void 0),l([r()],v.prototype,"active",void 0),l([r({aliasOf:"analysisVisualization.showGrid"})],v.prototype,"showGrid",void 0),l([r()],v.prototype,"editable",null),v=l([R("esri.views.3d.analysis.SliceAnalysisView3D")],v);const Ft=v;export{Ft as default};
